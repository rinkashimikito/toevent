---
phase: 05-external-calendar-apis
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - ToEvent/ToEvent/Services/GoogleCalendarProvider.swift
  - ToEvent/ToEvent/Models/GoogleAPIModels.swift
autonomous: true
user_setup: []

must_haves:
  truths:
    - "GoogleCalendarProvider implements CalendarProvider protocol"
    - "Events fetched from Google Calendar API appear with source .google"
    - "Calendar list fetched from Google includes color and title"
    - "401 errors trigger re-auth prompt (not silent retry)"
  artifacts:
    - path: "ToEvent/ToEvent/Services/GoogleCalendarProvider.swift"
      provides: "Google Calendar API implementation"
      exports: ["GoogleCalendarProvider"]
    - path: "ToEvent/ToEvent/Models/GoogleAPIModels.swift"
      provides: "Codable models for Google Calendar API responses"
      exports: ["GoogleCalendarsResponse", "GoogleEventsResponse", "GoogleEvent", "GoogleCalendar"]
  key_links:
    - from: "ToEvent/ToEvent/Services/GoogleCalendarProvider.swift"
      to: "https://www.googleapis.com/calendar/v3"
      via: "URLSession requests"
      pattern: "googleapis\\.com/calendar/v3"
    - from: "ToEvent/ToEvent/Services/GoogleCalendarProvider.swift"
      to: "AuthService"
      via: "credential retrieval"
      pattern: "AuthService\\.shared\\.getCredentials"
---

<objective>
Implement Google Calendar provider.

Purpose: Fetch calendars and events from Google Calendar API. Implements CalendarProvider protocol. Uses stored OAuth credentials from AuthService.

Output: GoogleCalendarProvider that fetches real data from Google Calendar API, GoogleAPIModels for JSON parsing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-external-calendar-apis/05-RESEARCH.md

@.planning/phases/05-external-calendar-apis/05-01-SUMMARY.md
@.planning/phases/05-external-calendar-apis/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Google API response models</name>
  <files>
    ToEvent/ToEvent/Models/GoogleAPIModels.swift
  </files>
  <action>
Create GoogleAPIModels.swift with Codable structs matching Google Calendar API v3 responses:

```swift
// GET /users/me/calendarList response
struct GoogleCalendarsResponse: Codable {
    let items: [GoogleCalendar]
}

struct GoogleCalendar: Codable {
    let id: String
    let summary: String
    let backgroundColor: String?
    let primary: Bool?
}

// GET /calendars/{id}/events response
struct GoogleEventsResponse: Codable {
    let items: [GoogleEvent]?
}

struct GoogleEvent: Codable {
    let id: String
    let summary: String?
    let start: GoogleEventDateTime
    let end: GoogleEventDateTime
    let status: String?
}

struct GoogleEventDateTime: Codable {
    let dateTime: String?  // RFC3339 for timed events
    let date: String?      // YYYY-MM-DD for all-day events
    let timeZone: String?
}
```

Conversion extensions:
- GoogleCalendar.toCalendarInfo(accountId:) -> CalendarInfo
- GoogleEvent.toEvent(calendarId:, calendarTitle:, calendarColor:, accountId:) -> Event

Color handling:
- backgroundColor is hex string like "#4285f4"
- Parse to CGColor using extension
  </action>
  <verify>Build succeeds. Models can be instantiated.</verify>
  <done>GoogleAPIModels compile. Can decode sample JSON responses.</done>
</task>

<task type="auto">
  <name>Task 2: Create GoogleCalendarProvider</name>
  <files>
    ToEvent/ToEvent/Services/GoogleCalendarProvider.swift
  </files>
  <action>
Create GoogleCalendarProvider.swift implementing CalendarProvider:

```swift
final class GoogleCalendarProvider: CalendarProvider {
    let providerType: CalendarProviderType = .google
    let account: CalendarAccount

    private var credentials: OAuthCredentials?
    private let baseURL = "https://www.googleapis.com/calendar/v3"

    init(account: CalendarAccount) {
        self.account = account
        self.credentials = AuthService.shared.getCredentials(for: account.id)
    }

    var isAuthenticated: Bool {
        credentials != nil && !(credentials?.isExpired ?? true)
    }

    func authenticate(presentingWindow: NSWindow?) async throws {
        guard let window = presentingWindow else {
            throw GoogleCalendarError.noWindow
        }
        credentials = try await AuthService.shared.startOAuthFlow(for: .google, presentingWindow: window)
    }

    func fetchCalendars() async throws -> [CalendarInfo] {
        let data = try await request(path: "/users/me/calendarList")
        let response = try JSONDecoder().decode(GoogleCalendarsResponse.self, from: data)
        return response.items.map { $0.toCalendarInfo(accountId: account.id) }
    }

    func fetchEvents(from: Date, to: Date, calendarIDs: [String]?) async throws -> [Event] {
        var allEvents: [Event] = []
        let calendars = try await fetchCalendars()
        let targetCalendars = calendarIDs.map { ids in
            calendars.filter { ids.contains($0.id) }
        } ?? calendars

        for calendar in targetCalendars {
            let events = try await fetchEventsForCalendar(calendar, from: from, to: to)
            allEvents.append(contentsOf: events)
        }

        return allEvents.sorted { $0.startDate < $1.startDate }
    }

    func signOut() async {
        try? AuthService.shared.deleteAccount(account.id)
        credentials = nil
    }

    private func fetchEventsForCalendar(_ calendar: CalendarInfo, from: Date, to: Date) async throws -> [Event]

    private func request(path: String, queryItems: [URLQueryItem] = []) async throws -> Data
}
```

Request method:
- Build URL with path and query items
- Add Authorization header with Bearer token
- Handle 401 -> throw authExpired error (caller will prompt re-auth)
- Handle 429/403 -> throw rateLimited error

Date formatting:
- Use ISO8601DateFormatter for timeMin/timeMax query params
- Parse dateTime/date fields from response

Error enum:
```swift
enum GoogleCalendarError: Error {
    case noWindow
    case notAuthenticated
    case authExpired
    case rateLimited
    case networkError(Error)
    case invalidResponse
}
```
  </action>
  <verify>Build succeeds. GoogleCalendarProvider instantiates with a mock CalendarAccount.</verify>
  <done>GoogleCalendarProvider implements CalendarProvider. Ready for integration once OAuth configured.</done>
</task>

</tasks>

<verification>
- [ ] `xcodebuild build` passes
- [ ] GoogleAPIModels can decode sample JSON (add unit test if time permits)
- [ ] GoogleCalendarProvider compiles and conforms to CalendarProvider
- [ ] Error handling covers 401 (auth expired) and 429 (rate limit)
</verification>

<success_criteria>
GoogleCalendarProvider implements CalendarProvider protocol.
API models correctly decode Google Calendar API responses.
Events have source .google and proper accountId.
Auth expiry triggers error (handled by caller).
</success_criteria>

<output>
After completion, create `.planning/phases/05-external-calendar-apis/05-03-SUMMARY.md`
</output>
