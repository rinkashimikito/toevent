---
phase: 05-external-calendar-apis
plan: 06
type: execute
wave: 4
depends_on: ["05-05"]
files_modified:
  - ToEvent/ToEvent/Views/Settings/CalendarSettingsView.swift
  - ToEvent/ToEvent/Views/Settings/AddAccountSheet.swift
  - ToEvent/ToEvent/Views/EventRowView.swift
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can add Google or Outlook account from Calendars settings"
    - "User can see which calendars come from which account"
    - "User can remove external accounts"
    - "Events show source icon in dropdown list"
    - "Re-auth prompt appears when account token expires"
  artifacts:
    - path: "ToEvent/ToEvent/Views/Settings/CalendarSettingsView.swift"
      provides: "Extended with Add Account button and account management"
      min_lines: 200
    - path: "ToEvent/ToEvent/Views/Settings/AddAccountSheet.swift"
      provides: "Sheet for selecting provider and triggering OAuth"
      exports: ["AddAccountSheet"]
  key_links:
    - from: "ToEvent/ToEvent/Views/Settings/CalendarSettingsView.swift"
      to: "AuthService"
      via: "addAccount button action"
      pattern: "AuthService\\.shared\\.startOAuthFlow"
    - from: "ToEvent/ToEvent/Views/Settings/CalendarSettingsView.swift"
      to: "CalendarProviderManager"
      via: "calendar list source"
      pattern: "CalendarProviderManager\\.shared"
---

<objective>
Extend Calendar settings UI for external account management.

Purpose: User can add Google/Outlook accounts, see source indicators on calendars, remove accounts, and handle re-authentication when tokens expire.

Output: Enhanced CalendarSettingsView with account management, AddAccountSheet for OAuth flow, source icons in EventRowView.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-external-calendar-apis/05-CONTEXT.md

@.planning/phases/05-external-calendar-apis/05-05-SUMMARY.md

@ToEvent/ToEvent/Views/Settings/CalendarSettingsView.swift
@ToEvent/ToEvent/Views/EventRowView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddAccountSheet</name>
  <files>
    ToEvent/ToEvent/Views/Settings/AddAccountSheet.swift
  </files>
  <action>
Create AddAccountSheet.swift:

```swift
struct AddAccountSheet: View {
    @Environment(\.dismiss) private var dismiss
    @State private var isAuthenticating = false
    @State private var error: String?

    let onAccountAdded: (CalendarAccount) -> Void

    var body: some View {
        VStack(spacing: 20) {
            Text("Add Calendar Account")
                .font(.headline)

            if let error = error {
                Text(error)
                    .foregroundColor(.red)
                    .font(.caption)
            }

            VStack(spacing: 12) {
                providerButton(for: .google)
                providerButton(for: .outlook)
            }
            .disabled(isAuthenticating)

            if isAuthenticating {
                ProgressView()
            }

            Button("Cancel") {
                dismiss()
            }
            .keyboardShortcut(.cancelAction)
        }
        .padding(20)
        .frame(width: 300)
    }

    private func providerButton(for provider: CalendarProviderType) -> some View {
        Button {
            authenticate(with: provider)
        } label: {
            HStack {
                Image(systemName: provider.sfSymbol)
                Text(provider.displayName)
            }
            .frame(maxWidth: .infinity)
        }
        .buttonStyle(.borderedProminent)
    }

    private func authenticate(with provider: CalendarProviderType) {
        isAuthenticating = true
        error = nil

        Task {
            do {
                guard let window = NSApp.keyWindow else {
                    throw AuthError.noWindow
                }
                let credentials = try await AuthService.shared.startOAuthFlow(
                    for: provider,
                    presentingWindow: window
                )
                let account = CalendarAccount(
                    id: credentials.accountId,
                    providerType: provider,
                    email: "...", // Extracted during OAuth
                    displayName: provider.displayName
                )
                await MainActor.run {
                    onAccountAdded(account)
                    dismiss()
                }
            } catch {
                await MainActor.run {
                    self.error = error.localizedDescription
                    self.isAuthenticating = false
                }
            }
        }
    }
}
```

Design per CONTEXT.md:
- Simple provider selection (not full account picker)
- Shows progress during OAuth flow
- Error display for failed auth
  </action>
  <verify>Build succeeds. Sheet can be previewed in Xcode canvas.</verify>
  <done>AddAccountSheet provides UI to trigger OAuth for Google or Outlook.</done>
</task>

<task type="auto">
  <name>Task 2: Extend CalendarSettingsView for account management</name>
  <files>
    ToEvent/ToEvent/Views/Settings/CalendarSettingsView.swift
  </files>
  <action>
Update CalendarSettingsView.swift:

Add state:
```swift
@State private var showingAddAccount = false
@State private var allCalendars: [CalendarInfo] = []
@ObservedObject private var providerManager = CalendarProviderManager.shared
@ObservedObject private var authService = AuthService.shared
```

Add "Add Account" button at top of calendar list:
```swift
Button {
    showingAddAccount = true
} label: {
    Label("Add Account", systemImage: "plus.circle")
}
.sheet(isPresented: $showingAddAccount) {
    AddAccountSheet { account in
        CalendarProviderManager.shared.addProvider(for: account)
        loadCalendars()
    }
}
```

Modify calendar row to show source icon:
```swift
private func calendarRow(for calendar: CalendarInfo) -> some View {
    HStack(spacing: 10) {
        // Source icon
        Image(systemName: calendar.providerType.sfSymbol)
            .foregroundColor(.secondary)
            .frame(width: 16)

        Circle()
            .fill(Color(cgColor: calendar.color))
            .frame(width: 10, height: 10)

        VStack(alignment: .leading, spacing: 2) {
            Text(calendar.title)
                .lineLimit(1)
            Text(calendar.source)
                .font(.caption)
                .foregroundStyle(.secondary)
        }

        Spacer()

        Toggle("", isOn: binding(for: calendar.id))
            .toggleStyle(.switch)
            .labelsHidden()
    }
}
```

Add section for connected accounts with remove option:
```swift
if !authService.accounts.isEmpty {
    Section("Connected Accounts") {
        ForEach(authService.accounts, id: \.id) { account in
            HStack {
                Image(systemName: account.providerType.sfSymbol)
                VStack(alignment: .leading) {
                    Text(account.displayName)
                    Text(account.email)
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }
                Spacer()
                Button("Remove") {
                    removeAccount(account)
                }
                .foregroundColor(.red)
            }
        }
    }
}
```

Add re-auth warning for expired accounts:
```swift
if !providerManager.expiredAccounts.isEmpty {
    Section {
        ForEach(providerManager.expiredAccounts, id: \.id) { account in
            HStack {
                Image(systemName: "exclamationmark.triangle.fill")
                    .foregroundColor(.orange)
                Text("\(account.displayName) needs re-authentication")
                Spacer()
                Button("Sign In") {
                    reauthenticate(account)
                }
            }
        }
    }
}
```

Update loadCalendars() to fetch from CalendarProviderManager:
```swift
private func loadCalendars() {
    Task {
        allCalendars = await CalendarProviderManager.shared.fetchAllCalendars()
        await MainActor.run {
            calendars = allCalendars
            appState.initializeCalendarPriority(with: calendars)
        }
    }
}
```
  </action>
  <verify>Build succeeds. CalendarSettingsView shows Add Account button and source icons.</verify>
  <done>CalendarSettingsView supports account management with source indicators.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>External calendar integration UI</what-built>
  <how-to-verify>
1. Open app and go to Settings -> Calendars
2. Verify "Add Account" button is visible
3. Click "Add Account" - verify sheet appears with Google and Outlook options
4. Verify local calendars show calendar icon, external would show g.circle or m.circle
5. Verify calendar rows show source label (e.g., "iCloud", "Gmail")
6. If you have OAuth credentials configured, test adding a Google or Outlook account
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] `xcodebuild build` passes
- [ ] CalendarSettingsView shows Add Account button
- [ ] AddAccountSheet opens and displays provider options
- [ ] Calendar rows show source icons
- [ ] Connected accounts section appears when accounts exist
- [ ] Re-auth warning appears for expired accounts
</verification>

<success_criteria>
User can add external calendar accounts from settings.
Calendars show source icons (local, Google, Outlook).
User can remove connected accounts.
Re-authentication prompts appear when tokens expire.
</success_criteria>

<output>
After completion, create `.planning/phases/05-external-calendar-apis/05-06-SUMMARY.md`
</output>
