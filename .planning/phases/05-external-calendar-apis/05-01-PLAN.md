---
phase: 05-external-calendar-apis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ToEvent/ToEvent/Models/CalendarProviderType.swift
  - ToEvent/ToEvent/Models/CalendarAccount.swift
  - ToEvent/ToEvent/Models/OAuthCredentials.swift
  - ToEvent/ToEvent/Services/CalendarProviderProtocol.swift
  - ToEvent/ToEvent/Services/LocalCalendarProvider.swift
  - ToEvent/ToEvent/Models/Event.swift
  - ToEvent/ToEvent/Models/CalendarInfo.swift
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Event model tracks which provider it came from"
    - "CalendarInfo model tracks which provider and account it belongs to"
    - "CalendarProvider protocol defines contract for all calendar sources"
    - "LocalCalendarProvider wraps existing CalendarService functionality"
  artifacts:
    - path: "ToEvent/ToEvent/Models/CalendarProviderType.swift"
      provides: "Provider type enum (local, google, outlook)"
      exports: ["CalendarProviderType"]
    - path: "ToEvent/ToEvent/Models/CalendarAccount.swift"
      provides: "Account model for external calendar accounts"
      exports: ["CalendarAccount"]
    - path: "ToEvent/ToEvent/Services/CalendarProviderProtocol.swift"
      provides: "Protocol defining calendar provider contract"
      exports: ["CalendarProvider"]
    - path: "ToEvent/ToEvent/Services/LocalCalendarProvider.swift"
      provides: "EventKit implementation of CalendarProvider"
      exports: ["LocalCalendarProvider"]
  key_links:
    - from: "ToEvent/ToEvent/Models/Event.swift"
      to: "CalendarProviderType"
      via: "source property"
      pattern: "source.*CalendarProviderType"
    - from: "ToEvent/ToEvent/Services/LocalCalendarProvider.swift"
      to: "CalendarService"
      via: "delegation"
      pattern: "CalendarService\\.shared"
---

<objective>
Establish protocol-based calendar provider architecture.

Purpose: Foundation for multi-source calendar integration. Abstracts EventKit behind a protocol so Google and Microsoft can implement the same interface. Existing functionality preserved via LocalCalendarProvider wrapper.

Output: CalendarProviderType enum, CalendarAccount model, OAuthCredentials model, CalendarProvider protocol, LocalCalendarProvider implementation, extended Event/CalendarInfo models with source tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-external-calendar-apis/05-RESEARCH.md

@ToEvent/ToEvent/Services/CalendarService.swift
@ToEvent/ToEvent/Models/Event.swift
@ToEvent/ToEvent/Models/CalendarInfo.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provider types and models</name>
  <files>
    ToEvent/ToEvent/Models/CalendarProviderType.swift
    ToEvent/ToEvent/Models/CalendarAccount.swift
    ToEvent/ToEvent/Models/OAuthCredentials.swift
  </files>
  <action>
Create CalendarProviderType.swift:
- Enum with cases: local, google, outlook
- Codable conformance for persistence
- Display name computed property ("Local Calendar", "Google Calendar", "Microsoft Outlook")
- SF Symbol name property for UI icons ("calendar", "g.circle", "m.circle")

Create CalendarAccount.swift:
- Struct with: id (UUID string), providerType, email (user identifier), displayName
- Codable conformance
- For local provider, use singleton pattern with fixed id "local"

Create OAuthCredentials.swift:
- Struct with: accessToken, refreshToken (optional), expiresAt (Date), accountId, providerType
- Codable conformance
- isExpired computed property (expiresAt <= Date())
- needsRefresh computed property (expires within 5 minutes)
  </action>
  <verify>Build succeeds with `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build`</verify>
  <done>Three new model files exist and compile without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create CalendarProvider protocol and LocalCalendarProvider</name>
  <files>
    ToEvent/ToEvent/Services/CalendarProviderProtocol.swift
    ToEvent/ToEvent/Services/LocalCalendarProvider.swift
  </files>
  <action>
Create CalendarProviderProtocol.swift:
```swift
protocol CalendarProvider {
    var providerType: CalendarProviderType { get }
    var account: CalendarAccount { get }
    var isAuthenticated: Bool { get }

    func authenticate(presentingWindow: NSWindow?) async throws
    func fetchEvents(from: Date, to: Date, calendarIDs: [String]?) async throws -> [Event]
    func fetchCalendars() async throws -> [CalendarInfo]
    func signOut() async
}
```

Create LocalCalendarProvider.swift:
- Implements CalendarProvider protocol
- providerType returns .local
- account returns singleton CalendarAccount with id "local", email "System", displayName "Local Calendars"
- isAuthenticated returns true if EKEventStore has full access
- authenticate() calls CalendarService.shared.requestAccess()
- fetchEvents() wraps CalendarService.shared.fetchUpcomingEvents() - convert TimeInterval lookahead to date range
- fetchCalendars() wraps CalendarService.shared.getCalendars()
- signOut() is no-op for local provider

Note: LocalCalendarProvider bridges existing CalendarService. Do NOT duplicate EventKit logic.
  </action>
  <verify>Build succeeds. LocalCalendarProvider can be instantiated without crashes.</verify>
  <done>CalendarProvider protocol exists. LocalCalendarProvider compiles and delegates to CalendarService.</done>
</task>

<task type="auto">
  <name>Task 3: Extend Event and CalendarInfo with source tracking</name>
  <files>
    ToEvent/ToEvent/Models/Event.swift
    ToEvent/ToEvent/Models/CalendarInfo.swift
  </files>
  <action>
Extend Event.swift:
- Add `source: CalendarProviderType` property (default .local)
- Add `accountId: String?` property (nil for local events)
- Update init(from: EKEvent) to set source = .local, accountId = nil
- Add convenience init for external events with explicit source and accountId

Extend CalendarInfo.swift:
- Add `providerType: CalendarProviderType` property (default .local)
- Add `accountId: String?` property (nil for local)
- Update init(from: EKCalendar) to set providerType = .local, accountId = nil
- Add convenience init for external calendars

Ensure backward compatibility: existing code that creates Event/CalendarInfo from EKEvent/EKCalendar continues to work unchanged.
  </action>
  <verify>Build succeeds. Existing CalendarService.fetchUpcomingEvents() still works (run app, check menu bar shows events).</verify>
  <done>Event and CalendarInfo have source/providerType properties. Existing functionality unchanged.</done>
</task>

</tasks>

<verification>
- [ ] `xcodebuild build` passes
- [ ] App launches without crash
- [ ] Existing local calendar events still appear in menu bar
- [ ] No regressions in Phase 1-4 functionality
</verification>

<success_criteria>
CalendarProviderType, CalendarAccount, OAuthCredentials models exist.
CalendarProvider protocol defines multi-source contract.
LocalCalendarProvider wraps CalendarService.
Event and CalendarInfo track their source.
Existing app behavior unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/05-external-calendar-apis/05-01-SUMMARY.md`
</output>
