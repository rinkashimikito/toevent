---
phase: 07-distribution-notarization
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - .github/workflows/release.yml
  - scripts/export-options.plist
autonomous: false

user_setup:
  - service: apple-developer
    why: "Code signing and notarization"
    env_vars:
      - name: BUILD_CERTIFICATE_BASE64
        source: "Keychain Access > Export Developer ID Application cert > base64 encode"
      - name: P12_PASSWORD
        source: "Password used when exporting certificate"
      - name: KEYCHAIN_PASSWORD
        source: "Any random string for temporary CI keychain"
      - name: APPLE_ID
        source: "Apple Developer account email"
      - name: TEAM_ID
        source: "developer.apple.com/account > Membership > Team ID (10 chars)"
      - name: NOTARIZATION_PASSWORD
        source: "appleid.apple.com > Sign-In and Security > App-Specific Passwords"
    dashboard_config:
      - task: "Create Developer ID Application certificate if not exists"
        location: "developer.apple.com/account > Certificates"
      - task: "Add GitHub secrets"
        location: "GitHub repo > Settings > Secrets and variables > Actions"
  - service: sparkle-signing
    why: "EdDSA signatures for secure updates"
    env_vars:
      - name: SPARKLE_PRIVATE_KEY
        source: "Generated via: ./Sparkle.framework/bin/generate_keys (run locally once, copy private key)"
    dashboard_config:
      - task: "Generate EdDSA keys locally"
        location: "Terminal: After building with Sparkle, run ./build/SourcePackages/artifacts/sparkle/Sparkle/bin/generate_keys"
      - task: "Copy public key to Info.plist SUPublicEDKey"
        location: "ToEvent/ToEvent/Info.plist"
      - task: "Store private key as GitHub secret SPARKLE_PRIVATE_KEY"
        location: "GitHub repo > Settings > Secrets and variables > Actions"

must_haves:
  truths:
    - "Git tag triggers automated release"
    - "Release includes signed .app in DMG"
    - "DMG is notarized and stapled"
    - "GitHub release has DMG and ZIP artifacts"
    - "Appcast is updated for Sparkle with EdDSA signature"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Automated release pipeline"
      contains: "notarytool"
    - path: "scripts/export-options.plist"
      provides: "Developer ID export configuration"
      contains: "developer-id"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "scripts/export-options.plist"
      via: "-exportOptionsPlist flag"
      pattern: "export-options.plist"
    - from: ".github/workflows/release.yml"
      to: "SPARKLE_PRIVATE_KEY secret"
      via: "sign_update tool invocation"
      pattern: "sign_update"
    - from: "appcast.xml"
      to: "GitHub release ZIP"
      via: "enclosure URL"
      pattern: "releases/download/.*/ToEvent.*\\.zip"
---

<objective>
Create GitHub Actions workflow for automated build, sign, notarize, and release

Purpose: Automate the entire release pipeline so tagging a version produces a signed, notarized release
Output: Complete CI/CD workflow that builds DMG, notarizes with Apple, generates signed appcast, and creates GitHub release
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-distribution-notarization/07-RESEARCH.md

@ToEvent/ToEvent/Info.plist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export-options.plist and release workflow with EdDSA signing</name>
  <files>
    scripts/export-options.plist
    .github/workflows/release.yml
  </files>
  <action>
    1. Create scripts/export-options.plist:
       ```xml
       <?xml version="1.0" encoding="UTF-8"?>
       <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
       <plist version="1.0">
       <dict>
           <key>method</key>
           <string>developer-id</string>
           <key>signingStyle</key>
           <string>automatic</string>
       </dict>
       </plist>
       ```

    2. Create .github/workflows/release.yml:
       ```yaml
       name: Release

       on:
         push:
           tags:
             - 'v*.*.*'

       jobs:
         build:
           runs-on: macos-14
           permissions:
             contents: write

           steps:
             - uses: actions/checkout@v4

             - name: Install create-dmg
               run: brew install create-dmg

             - name: Install certificate
               env:
                 BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
                 P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
                 KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
               run: |
                 CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
                 KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

                 echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

                 security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
                 security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
                 security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

                 security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
                 security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
                 security list-keychain -d user -s $KEYCHAIN_PATH

             - name: Resolve packages
               run: |
                 xcodebuild -resolvePackageDependencies \
                   -project ToEvent/ToEvent.xcodeproj \
                   -scheme ToEvent

             - name: Archive
               run: |
                 xcodebuild archive \
                   -project ToEvent/ToEvent.xcodeproj \
                   -scheme ToEvent \
                   -configuration Release \
                   -archivePath build/ToEvent.xcarchive \
                   -destination "generic/platform=macOS"

             - name: Export
               run: |
                 xcodebuild -exportArchive \
                   -archivePath build/ToEvent.xcarchive \
                   -exportPath build/export \
                   -exportOptionsPlist scripts/export-options.plist

             - name: Create DMG
               run: |
                 VERSION=${GITHUB_REF#refs/tags/v}
                 create-dmg \
                   --volname "ToEvent" \
                   --window-pos 200 120 \
                   --window-size 600 400 \
                   --icon-size 100 \
                   --icon "ToEvent.app" 150 185 \
                   --app-drop-link 450 185 \
                   "build/ToEvent-${VERSION}.dmg" \
                   "build/export/ToEvent.app"

             - name: Notarize
               env:
                 APPLE_ID: ${{ secrets.APPLE_ID }}
                 TEAM_ID: ${{ secrets.TEAM_ID }}
                 NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
               run: |
                 VERSION=${GITHUB_REF#refs/tags/v}

                 xcrun notarytool submit "build/ToEvent-${VERSION}.dmg" \
                   --apple-id "$APPLE_ID" \
                   --team-id "$TEAM_ID" \
                   --password "$NOTARIZATION_PASSWORD" \
                   --wait

                 xcrun stapler staple "build/ToEvent-${VERSION}.dmg"

             - name: Create ZIP for Sparkle
               run: |
                 VERSION=${GITHUB_REF#refs/tags/v}
                 cd build/export
                 zip -r ../ToEvent-${VERSION}.zip ToEvent.app

             - name: Sign update and generate appcast
               env:
                 SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
               run: |
                 VERSION=${GITHUB_REF#refs/tags/v}
                 DATE=$(date -u +"%a, %d %b %Y %H:%M:%S +0000")
                 SIZE=$(stat -f%z "build/ToEvent-${VERSION}.zip")

                 # Extract Sparkle tools from SPM cache
                 SPARKLE_BIN=$(find ~/Library/Developer/Xcode/DerivedData -name "sign_update" -path "*/Sparkle/*" 2>/dev/null | head -1)

                 # If not found in DerivedData, check SourcePackages
                 if [ -z "$SPARKLE_BIN" ]; then
                   SPARKLE_BIN=$(find build -name "sign_update" -path "*Sparkle*" 2>/dev/null | head -1)
                 fi

                 # Generate EdDSA signature
                 if [ -n "$SPARKLE_BIN" ] && [ -n "$SPARKLE_PRIVATE_KEY" ]; then
                   ED_SIGNATURE=$(echo -n "$SPARKLE_PRIVATE_KEY" | "$SPARKLE_BIN" --ed-key-file - "build/ToEvent-${VERSION}.zip")
                 else
                   echo "Warning: sign_update not found or SPARKLE_PRIVATE_KEY not set, signature will be empty"
                   ED_SIGNATURE=""
                 fi

                 cat > appcast.xml << EOF
                 <?xml version="1.0" encoding="UTF-8"?>
                 <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
                   <channel>
                     <title>ToEvent Updates</title>
                     <language>en</language>
                     <item>
                       <title>Version ${VERSION}</title>
                       <sparkle:version>${VERSION}</sparkle:version>
                       <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
                       <sparkle:releaseNotesLink>https://github.com/Immedio/toevent/releases/tag/v${VERSION}</sparkle:releaseNotesLink>
                       <pubDate>${DATE}</pubDate>
                       <enclosure
                         url="https://github.com/Immedio/toevent/releases/download/v${VERSION}/ToEvent-${VERSION}.zip"
                         sparkle:edSignature="${ED_SIGNATURE}"
                         length="${SIZE}"
                         type="application/octet-stream" />
                     </item>
                   </channel>
                 </rss>
                 EOF

             - name: Create Release
               uses: softprops/action-gh-release@v1
               with:
                 files: |
                   build/ToEvent-*.dmg
                   build/ToEvent-*.zip
                   appcast.xml
                 generate_release_notes: true
       ```

    CRITICAL NOTES:
    - EdDSA signing requires SPARKLE_PRIVATE_KEY secret (generated locally via generate_keys)
    - sign_update tool generates signature for ZIP file
    - appcast.xml is uploaded to release assets (not committed to repo)
    - SUFeedURL in Info.plist (Plan 01) points to releases/latest/download/appcast.xml
    - This matches: release creates appcast.xml -> uploads to assets -> app fetches from releases/latest/download/
  </action>
  <verify>
    - scripts/export-options.plist is valid plist
    - .github/workflows/release.yml is valid YAML: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"`
    - Workflow references correct project path
    - Workflow includes sign_update step for EdDSA signature
    - Workflow uploads appcast.xml to release assets
    - All required secrets are documented (including SPARKLE_PRIVATE_KEY)
  </verify>
  <done>
    Release workflow created with archive, export, DMG creation, notarization, EdDSA signing, and GitHub release
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    GitHub Actions release workflow that:
    1. Triggers on v*.*.* tags
    2. Imports Developer ID certificate from secrets
    3. Archives and exports with Developer ID signing
    4. Creates DMG with create-dmg
    5. Notarizes with notarytool
    6. Staples notarization ticket
    7. Creates ZIP for Sparkle updates
    8. Signs ZIP with EdDSA using SPARKLE_PRIVATE_KEY
    9. Generates appcast.xml with signature
    10. Creates GitHub release with artifacts (DMG, ZIP, appcast.xml)
  </what-built>
  <how-to-verify>
    1. Review .github/workflows/release.yml for correctness
    2. Verify secrets list matches what you have available:
       - BUILD_CERTIFICATE_BASE64
       - P12_PASSWORD
       - KEYCHAIN_PASSWORD
       - APPLE_ID
       - TEAM_ID
       - NOTARIZATION_PASSWORD
       - SPARKLE_PRIVATE_KEY (NEW - must generate locally first)
    3. Generate EdDSA keys (one-time setup):
       - Build the project in Xcode to download Sparkle
       - Find generate_keys: find ~/Library/Developer/Xcode/DerivedData -name "generate_keys" -path "*Sparkle*"
       - Run it: ./path/to/generate_keys
       - Copy PUBLIC key to ToEvent/ToEvent/Info.plist SUPublicEDKey value
       - Copy PRIVATE key to GitHub secret SPARKLE_PRIVATE_KEY
    4. Confirm you have Developer ID Application certificate (not Development)
    5. Add all secrets to GitHub repository: Settings > Secrets and variables > Actions
    6. To test: Create and push a tag (git tag v0.9.0 && git push origin v0.9.0)
  </how-to-verify>
  <resume-signal>Type "secrets configured" when GitHub secrets are set up (including SPARKLE_PRIVATE_KEY), or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] export-options.plist exists with developer-id method
- [ ] release.yml triggers on version tags
- [ ] Workflow imports certificate correctly
- [ ] Workflow runs xcodebuild archive and export
- [ ] Workflow creates DMG with create-dmg
- [ ] Workflow notarizes with notarytool
- [ ] Workflow staples after notarization
- [ ] Workflow signs ZIP with EdDSA (sign_update tool)
- [ ] Workflow generates appcast.xml with edSignature
- [ ] Workflow creates GitHub release with artifacts
- [ ] SUPublicEDKey in Info.plist matches generated public key
</verification>

<success_criteria>
Pushing a version tag (v0.9.0) triggers workflow that produces signed, notarized DMG and EdDSA-signed ZIP, uploads to GitHub release with properly signed appcast.xml. Sparkle can verify update integrity using public key in Info.plist.
</success_criteria>

<output>
After completion, create `.planning/phases/07-distribution-notarization/07-04-SUMMARY.md`
</output>
