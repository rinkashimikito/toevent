---
phase: 07-distribution-notarization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ToEvent/ToEvent.xcodeproj/project.pbxproj
  - ToEvent/ToEvent/ToEvent.entitlements
  - ToEvent/ToEvent/Info.plist
  - ToEvent/ToEvent/ToEventApp.swift
  - ToEvent/ToEvent/Views/Settings/GeneralSettingsView.swift
  - ToEvent/ToEvent/Services/UpdaterController.swift
autonomous: true

must_haves:
  truths:
    - "App checks for updates on launch"
    - "User can manually check for updates from Settings"
    - "Updates download and install correctly"
  artifacts:
    - path: "ToEvent/ToEvent/Services/UpdaterController.swift"
      provides: "Sparkle updater wrapper"
      exports: ["UpdaterController"]
    - path: "ToEvent/ToEvent/ToEvent.entitlements"
      provides: "XPC service entitlements for Sparkle"
      contains: "mach-lookup.global-name"
    - path: "ToEvent/ToEvent/Info.plist"
      provides: "Sparkle configuration keys"
      contains: "SUFeedURL"
  key_links:
    - from: "ToEventApp.swift"
      to: "UpdaterController"
      via: "StateObject initialization"
      pattern: "UpdaterController"
    - from: "GeneralSettingsView.swift"
      to: "UpdaterController"
      via: "Check for Updates button"
      pattern: "checkForUpdates"
    - from: "Info.plist"
      to: "GitHub releases"
      via: "SUFeedURL pointing to release asset"
      pattern: "releases/latest/download/appcast.xml"
---

<objective>
Integrate Sparkle 2 auto-update framework for sandboxed app

Purpose: Enable automatic updates so users always have latest version without manual download
Output: App with working auto-update mechanism via Sparkle
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-distribution-notarization/07-RESEARCH.md

@ToEvent/ToEvent/ToEventApp.swift
@ToEvent/ToEvent/ToEvent.entitlements
@ToEvent/ToEvent/Info.plist
@ToEvent/ToEvent/Views/Settings/GeneralSettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Sparkle package and configure entitlements</name>
  <files>
    ToEvent/ToEvent.xcodeproj/project.pbxproj
    ToEvent/ToEvent/ToEvent.entitlements
    ToEvent/ToEvent/Info.plist
  </files>
  <action>
    1. Add Sparkle SPM package to Xcode project:
       - Package URL: https://github.com/sparkle-project/Sparkle
       - Version: Up to Next Major 2.0.0
       - Add Sparkle framework to ToEvent target

    2. Update ToEvent.entitlements with XPC service exceptions for Sparkle sandboxing:
       ```xml
       <key>com.apple.security.temporary-exception.mach-lookup.global-name</key>
       <array>
           <string>$(PRODUCT_BUNDLE_IDENTIFIER)-spks</string>
           <string>$(PRODUCT_BUNDLE_IDENTIFIER)-spki</string>
       </array>
       ```

    3. Add Sparkle keys to Info.plist:
       ```xml
       <key>SUFeedURL</key>
       <string>https://github.com/Immedio/toevent/releases/latest/download/appcast.xml</string>
       <key>SUEnableInstallerLauncherService</key>
       <true/>
       <key>SUPublicEDKey</key>
       <string></string>
       ```

       IMPORTANT: SUFeedURL points to GitHub release assets (latest/download/appcast.xml), NOT raw repo file.
       This ensures appcast.xml is fetched from release artifacts where it's uploaded by the release workflow.

       Note: SUPublicEDKey left empty - will be populated during first release after EdDSA key generation (see Plan 04).

    IMPORTANT: Sparkle 2 requires XPC services for sandboxed apps. The mach-lookup entitlements allow the main app to communicate with the installer/helper services bundled in Sparkle.
  </action>
  <verify>
    - Project builds without errors: `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build`
    - Sparkle framework linked: Check project.pbxproj contains "Sparkle"
    - Entitlements contain XPC exceptions: grep "mach-lookup" ToEvent/ToEvent/ToEvent.entitlements
    - Info.plist contains correct SUFeedURL: grep "releases/latest/download/appcast.xml" ToEvent/ToEvent/Info.plist
  </verify>
  <done>
    Sparkle package added to project, entitlements configured for sandboxed XPC communication, Info.plist has appcast URL pointing to GitHub release assets
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UpdaterController and integrate with app</name>
  <files>
    ToEvent/ToEvent/Services/UpdaterController.swift
    ToEvent/ToEvent/ToEventApp.swift
    ToEvent/ToEvent/Views/Settings/GeneralSettingsView.swift
  </files>
  <action>
    1. Create UpdaterController.swift in Services:
       ```swift
       import Foundation
       import Sparkle

       final class UpdaterController: ObservableObject {
           private let updaterController: SPUStandardUpdaterController

           @Published var canCheckForUpdates = false

           init() {
               updaterController = SPUStandardUpdaterController(
                   startingUpdater: true,
                   updaterDelegate: nil,
                   userDriverDelegate: nil
               )

               updaterController.updater.publisher(for: \.canCheckForUpdates)
                   .assign(to: &$canCheckForUpdates)
           }

           func checkForUpdates() {
               updaterController.updater.checkForUpdates()
           }
       }
       ```

    2. Update ToEventApp.swift:
       - Add import Sparkle
       - Add @StateObject for UpdaterController
       - Pass to settings view via environment

    3. Update GeneralSettingsView.swift:
       - Add "Check for Updates" button in General settings
       - Use @EnvironmentObject to access UpdaterController
       - Disable button when canCheckForUpdates is false

    Pattern: Use SPUStandardUpdaterController for standard UI (shows progress, prompts user). The updater automatically checks on launch based on user preferences.
  </action>
  <verify>
    - Build succeeds: `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build`
    - UpdaterController exists and compiles
    - GeneralSettingsView has Check for Updates button
    - Run app, open Settings > General, verify button exists
  </verify>
  <done>
    UpdaterController wraps Sparkle, integrated in app, Check for Updates button in Settings
  </done>
</task>

</tasks>

<verification>
- [ ] Project builds with Sparkle framework
- [ ] Entitlements have XPC mach-lookup exceptions
- [ ] Info.plist has SUFeedURL pointing to releases/latest/download/appcast.xml
- [ ] UpdaterController initializes without crash
- [ ] Check for Updates button visible in General settings
- [ ] App launches without Sparkle-related errors in Console
</verification>

<success_criteria>
Sparkle 2 framework integrated and configured. App will check for updates on launch and user can manually trigger update check from Settings. SUFeedURL correctly points to GitHub release assets. Ready for release workflow to generate signing keys and appcast.
</success_criteria>

<output>
After completion, create `.planning/phases/07-distribution-notarization/07-01-SUMMARY.md`
</output>
