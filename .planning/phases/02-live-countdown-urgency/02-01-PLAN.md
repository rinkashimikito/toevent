---
phase: 02-live-countdown-urgency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ToEvent/ToEvent.xcodeproj/project.pbxproj
  - ToEvent/ToEvent/Utilities/UrgencyLevel.swift
  - ToEvent/ToEvent/Utilities/DateFormatters.swift
  - ToEvent/ToEvent/Services/SystemStateService.swift
autonomous: true

must_haves:
  truths:
    - "UrgencyLevel enum provides threshold-based urgency classification"
    - "Hybrid time format shows seconds when event is within 5 minutes"
    - "Screen lock state can be detected and observed"
  artifacts:
    - path: "ToEvent/ToEvent/Utilities/UrgencyLevel.swift"
      provides: "Urgency level enum with threshold logic and colors"
      exports: ["UrgencyLevel"]
    - path: "ToEvent/ToEvent/Utilities/DateFormatters.swift"
      provides: "Extended formatters including hybrid countdown"
      exports: ["formatHybridCountdown"]
    - path: "ToEvent/ToEvent/Services/SystemStateService.swift"
      provides: "Screen lock detection service"
      exports: ["SystemStateService"]
  key_links:
    - from: "ToEvent/ToEvent/Utilities/UrgencyLevel.swift"
      to: "AppKit NSColor"
      via: "color property returning NSColor"
      pattern: "var color: NSColor"
---

<objective>
Add foundational infrastructure for urgency-based countdown display: urgency level enum with color mappings, hybrid time formatter with seconds precision, and screen lock detection service.

Purpose: Plan 2 needs these utilities to implement colored text and adaptive updates. Separating foundation from integration keeps context low.
Output: UrgencyLevel.swift, extended DateFormatters.swift, SystemStateService.swift
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-live-countdown-urgency/02-CONTEXT.md
@.planning/phases/02-live-countdown-urgency/02-RESEARCH.md

# Existing code to reference
@ToEvent/ToEvent/Utilities/DateFormatters.swift
@ToEvent/ToEvent/Services/CalendarService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MenuBarExtraAccess package dependency</name>
  <files>ToEvent/ToEvent.xcodeproj/project.pbxproj</files>
  <action>
Add MenuBarExtraAccess package via Swift Package Manager:
- Package URL: https://github.com/orchetect/MenuBarExtraAccess
- Version: Latest (use "Up to Next Major Version" from current)
- Target: ToEvent

Use Xcode command line or manual project.pbxproj edit. The package provides access to NSStatusItem from MenuBarExtra for setting attributedTitle.

Note: This is an Xcode project (not Package.swift), so use xcodebuild or direct pbxproj modification.
  </action>
  <verify>
Open ToEvent.xcodeproj in Xcode, check Package Dependencies section shows MenuBarExtraAccess.
Or: `grep -r "MenuBarExtraAccess" ToEvent/ToEvent.xcodeproj/`
  </verify>
  <done>MenuBarExtraAccess package is listed as a dependency in the Xcode project</done>
</task>

<task type="auto">
  <name>Task 2: Create UrgencyLevel enum and hybrid formatter</name>
  <files>
    ToEvent/ToEvent/Utilities/UrgencyLevel.swift
    ToEvent/ToEvent/Utilities/DateFormatters.swift
  </files>
  <action>
Create UrgencyLevel.swift:
```swift
import AppKit

enum UrgencyLevel: Comparable {
    case normal      // > 1 hour
    case approaching // <= 1 hour (yellow)
    case soon        // <= 30 minutes (orange)
    case imminent    // <= 15 minutes (red)
    case now         // event started

    static func from(secondsRemaining: TimeInterval) -> UrgencyLevel {
        switch secondsRemaining {
        case ...0: return .now
        case 0..<900: return .imminent      // 15 min
        case 900..<1800: return .soon       // 30 min
        case 1800..<3600: return .approaching // 1 hour
        default: return .normal
        }
    }

    var color: NSColor {
        switch self {
        case .normal: return .labelColor
        case .approaching: return .systemYellow
        case .soon: return .systemOrange
        case .imminent, .now: return .systemRed
        }
    }

    // For icon: filled when soon or closer, outline otherwise
    var iconFilled: Bool {
        self >= .soon
    }
}
```

Extend DateFormatters.swift with formatHybridCountdown:
- Shows seconds when <= 5 minutes (300 seconds)
- Shows "Now" when interval <= 0
- Format examples: "2h 15m", "45m", "4m 32s", "28s", "Now"
- Keep existing formatRelativeTime for backwards compatibility

```swift
static func formatHybridCountdown(until date: Date, from now: Date = Date()) -> String {
    let interval = date.timeIntervalSince(now)

    if interval <= 0 {
        return "Now"
    }

    if interval < 60 {
        return String(format: "%ds", Int(interval))
    }

    if interval < 300 { // 5 minutes - show seconds
        let minutes = Int(interval) / 60
        let seconds = Int(interval) % 60
        return String(format: "%dm %02ds", minutes, seconds)
    }

    if interval < 3600 { // 1 hour - minutes only
        let minutes = Int(interval) / 60
        return "\(minutes)m"
    }

    // Hours and minutes
    let hours = Int(interval) / 3600
    let minutes = (Int(interval) % 3600) / 60
    if minutes == 0 {
        return "\(hours)h"
    }
    return "\(hours)h \(minutes)m"
}

// Returns true if countdown should show seconds (for adaptive update scheduling)
static func shouldShowSeconds(until date: Date, from now: Date = Date()) -> Bool {
    let interval = date.timeIntervalSince(now)
    return interval > 0 && interval < 300 // 5 minutes
}
```
  </action>
  <verify>
Build project: `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build`
Test UrgencyLevel thresholds manually: .from(secondsRemaining: 3700) == .normal, .from(secondsRemaining: 800) == .imminent
  </verify>
  <done>
UrgencyLevel enum compiles with correct threshold logic and NSColor mappings.
formatHybridCountdown produces "2h 15m" for far events, "4m 32s" for close events.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SystemStateService for screen lock detection</name>
  <files>ToEvent/ToEvent/Services/SystemStateService.swift</files>
  <action>
Create SystemStateService.swift following the pattern from CalendarService:
```swift
import Foundation
import Combine
import AppKit

final class SystemStateService: ObservableObject {
    static let shared = SystemStateService()

    @Published private(set) var isScreenLocked = false

    private init() {
        observeLockState()
        observeWake()
    }

    private func observeLockState() {
        let dnc = DistributedNotificationCenter.default()

        dnc.addObserver(
            forName: .init("com.apple.screenIsLocked"),
            object: nil,
            queue: .main
        ) { [weak self] _ in
            self?.isScreenLocked = true
        }

        dnc.addObserver(
            forName: .init("com.apple.screenIsUnlocked"),
            object: nil,
            queue: .main
        ) { [weak self] _ in
            self?.isScreenLocked = false
        }
    }

    // Also observe wake to handle edge case where unlock doesn't fire
    private func observeWake() {
        NSWorkspace.shared.notificationCenter.addObserver(
            forName: NSWorkspace.didWakeNotification,
            object: nil,
            queue: .main
        ) { [weak self] _ in
            // Treat wake as potential unlock - timer will resume
            // If actually still locked, next lock notification will pause again
            self?.isScreenLocked = false
        }
    }
}
```

Note: Uses singleton pattern matching CalendarService. The service publishes isScreenLocked which AppState will observe to pause/resume updates.
  </action>
  <verify>
Build project: `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build`
Check file exists and compiles without errors.
  </verify>
  <done>
SystemStateService compiles, observes screen lock/unlock notifications, publishes isScreenLocked state.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Project builds without errors
2. `grep "MenuBarExtraAccess" ToEvent/ToEvent.xcodeproj/project.pbxproj` returns matches
3. UrgencyLevel.swift exists with threshold logic
4. DateFormatters.swift contains formatHybridCountdown function
5. SystemStateService.swift exists with lock detection
</verification>

<success_criteria>
- MenuBarExtraAccess dependency added to Xcode project
- UrgencyLevel enum provides .normal/.approaching/.soon/.imminent/.now with correct thresholds
- UrgencyLevel.color returns appropriate NSColor for each level
- formatHybridCountdown returns "2h 15m", "45m", "4m 32s", "Now" based on interval
- shouldShowSeconds returns true when interval < 300 seconds
- SystemStateService.shared.isScreenLocked publishes lock state changes
- All code compiles and integrates with existing project structure
</success_criteria>

<output>
After completion, create `.planning/phases/02-live-countdown-urgency/02-01-SUMMARY.md`
</output>
