---
phase: 03-dropdown-event-list
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ToEvent/ToEvent/State/AppState.swift
  - ToEvent/ToEvent/Models/Event.swift
  - ToEvent/ToEvent/Services/CalendarService.swift
autonomous: true

must_haves:
  truths:
    - "AppState exposes list of upcoming events (not just first)"
    - "Events have calendar title available for AppleScript lookup"
    - "Past events are filtered out before display"
  artifacts:
    - path: "ToEvent/ToEvent/State/AppState.swift"
      provides: "events array with filtered upcoming events"
      contains: "@Published private(set) var events"
    - path: "ToEvent/ToEvent/Models/Event.swift"
      provides: "calendarTitle property for AppleScript"
      contains: "calendarTitle: String"
  key_links:
    - from: "AppState.refreshEvents()"
      to: "CalendarService.fetchUpcomingEvents()"
      via: "stores full array, not just first"
      pattern: "self\\.events = events"
---

<objective>
Expose full event list in AppState with calendar titles for AppleScript integration.

Purpose: The dropdown needs to display multiple events, and clicking events requires calendar title for AppleScript `show` command. Currently AppState only stores `nextEvent`.

Output: AppState.events array with Event model containing calendarTitle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dropdown-event-list/03-RESEARCH.md

# Existing source files
@ToEvent/ToEvent/State/AppState.swift
@ToEvent/ToEvent/Models/Event.swift
@ToEvent/ToEvent/Services/CalendarService.swift
@ToEvent/ToEvent/Models/CalendarInfo.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add calendarTitle to Event model</name>
  <files>
    ToEvent/ToEvent/Models/Event.swift
    ToEvent/ToEvent/Services/CalendarService.swift
  </files>
  <action>
    Modify Event.swift to add `calendarTitle: String` property. AppleScript needs human-readable calendar title, not calendarIdentifier.

    In Event.swift:
    - Add `let calendarTitle: String` property after calendarID
    - Update init() to accept calendarTitle parameter
    - In init(from ekEvent:), set calendarTitle from `ekEvent.calendar?.title ?? "Unknown"`

    In CalendarService.fetchUpcomingEvents():
    - No changes needed - EKEvent already has calendar.title accessible in Event init
  </action>
  <verify>
    Build succeeds with no errors:
    ```
    cd ToEvent && xcodebuild -scheme ToEvent -configuration Debug build 2>&1 | tail -20
    ```
  </verify>
  <done>Event model has calendarTitle property populated from EKEvent.calendar.title</done>
</task>

<task type="auto">
  <name>Task 2: Store full events array in AppState</name>
  <files>ToEvent/ToEvent/State/AppState.swift</files>
  <action>
    Modify AppState to store full events list instead of just first event.

    Add new published property:
    ```swift
    @Published private(set) var events: [Event] = []
    ```

    Modify refreshEvents():
    - Store all events: `self.events = events`
    - Keep nextEvent computed from events array: `self.nextEvent = events.first`
    - Note: CalendarService already returns events sorted by startDate then priority

    Add computed properties for event grouping (used by EventListView in Plan 02):
    ```swift
    var allDayEvents: [Event] {
        events.filter { $0.isAllDay }
    }

    var timedEvents: [Event] {
        events.filter { !$0.isAllDay }
    }
    ```

    The filtering of past events happens naturally because CalendarService.fetchUpcomingEvents uses `now` as start date. Events that have started will be excluded on next refresh.

    For the timer tick, add event expiry check in tickCountdown():
    - If nextEvent exists and nextEvent.startDate <= currentTime, call refreshEvents()
    - This removes events from list when they start (DROP-07)
  </action>
  <verify>
    Build succeeds:
    ```
    cd ToEvent && xcodebuild -scheme ToEvent -configuration Debug build 2>&1 | tail -20
    ```

    Grep for new property:
    ```
    grep -n "var events:" ToEvent/ToEvent/State/AppState.swift
    ```
  </verify>
  <done>AppState.events contains full event list, allDayEvents/timedEvents computed properties exist, events auto-refresh when they start</done>
</task>

</tasks>

<verification>
1. Build succeeds without warnings
2. AppState has `events: [Event]` published property
3. Event model has `calendarTitle: String` property
4. Computed properties `allDayEvents` and `timedEvents` exist
5. Events refresh when an event starts (tickCountdown triggers refreshEvents)
</verification>

<success_criteria>
- Event.calendarTitle populated from EKEvent.calendar.title
- AppState.events contains all upcoming events (not just first)
- AppState.allDayEvents and timedEvents filter correctly
- Events disappear from list after they start (refresh on tick)
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-dropdown-event-list/03-01-SUMMARY.md`
</output>
