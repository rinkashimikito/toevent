---
phase: 03-dropdown-event-list
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - ToEvent/ToEvent/Views/EventRowView.swift
  - ToEvent/ToEvent/Views/EventListView.swift
  - ToEvent/ToEvent/Views/MenuBarView.swift
autonomous: true

must_haves:
  truths:
    - "Dropdown shows list of upcoming events with calendar colors"
    - "All-day events appear grouped at top"
    - "When no events today, tomorrow's events shown with header"
    - "Each row shows event title, time, and countdown"
    - "Rows have hover and pressed visual states"
    - "Footer bar has gear icon and refresh button"
  artifacts:
    - path: "ToEvent/ToEvent/Views/EventRowView.swift"
      provides: "Single event row with hover state and calendar tint"
      min_lines: 40
    - path: "ToEvent/ToEvent/Views/EventListView.swift"
      provides: "VStack-based event list with grouping"
      min_lines: 50
    - path: "ToEvent/ToEvent/Views/MenuBarView.swift"
      provides: "Updated menu bar dropdown with event list and footer"
      contains: "EventListView"
  key_links:
    - from: "EventListView"
      to: "AppState.events"
      via: "EnvironmentObject"
      pattern: "@EnvironmentObject.*appState"
    - from: "MenuBarView"
      to: "EventListView"
      via: "composition"
      pattern: "EventListView\\(\\)"
---

<objective>
Build event list UI with row styling, grouping, and footer bar.

Purpose: Users need to see all upcoming events in the dropdown, with visual hierarchy (all-day vs timed), calendar colors, and quick access to settings/refresh.

Output: EventRowView, EventListView, updated MenuBarView with full dropdown.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dropdown-event-list/03-RESEARCH.md
@.planning/phases/03-dropdown-event-list/03-01-SUMMARY.md

# Source files
@ToEvent/ToEvent/Views/MenuBarView.swift
@ToEvent/ToEvent/State/AppState.swift
@ToEvent/ToEvent/Models/Event.swift
@ToEvent/ToEvent/Utilities/DateFormatters.swift
@ToEvent/ToEvent/Utilities/UrgencyLevel.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EventRowView</name>
  <files>ToEvent/ToEvent/Views/EventRowView.swift</files>
  <action>
    Create new file EventRowView.swift in Views folder.

    Structure:
    ```swift
    import SwiftUI

    struct EventRowView: View {
        let event: Event
        var onTap: () -> Void = {}

        @State private var isHovered = false

        var body: some View {
            Button(action: onTap) {
                rowContent
            }
            .buttonStyle(EventRowButtonStyle(isHovered: isHovered, calendarColor: event.calendarColor))
            .onHover { hovering in
                isHovered = hovering
            }
        }

        private var rowContent: some View {
            // HStack with:
            // - Calendar color dot (8x8 circle)
            // - Title (truncated to ~30 chars, lineLimit 1)
            // - Spacer
            // - Time display (startTime or "All day" or countdown based on proximity)
        }
    }
    ```

    EventRowButtonStyle:
    - No background when idle
    - Subtle calendar color tint (opacity 0.1) on hover
    - Accent color tint (opacity 0.2) when pressed
    - Rounded corners (6pt radius)
    - Padding horizontal 12, vertical 8

    Time display logic (per CONTEXT.md - minimal default):
    - For all-day events: show "All day"
    - For timed events within 1 hour: show countdown (use DateFormatters.formatHybridCountdown)
    - For timed events > 1 hour: show start time (e.g., "2:30 PM")

    Use DateFormatter for time:
    ```swift
    private static let timeFormatter: DateFormatter = {
        let formatter = DateFormatter()
        formatter.timeStyle = .short
        return formatter
    }()
    ```
  </action>
  <verify>
    File exists and compiles:
    ```
    ls ToEvent/ToEvent/Views/EventRowView.swift
    cd ToEvent && xcodebuild -scheme ToEvent -configuration Debug build 2>&1 | tail -20
    ```
  </verify>
  <done>EventRowView renders event with title, calendar dot, time/countdown, hover/pressed states</done>
</task>

<task type="auto">
  <name>Task 2: Create EventListView</name>
  <files>ToEvent/ToEvent/Views/EventListView.swift</files>
  <action>
    Create new file EventListView.swift in Views folder.

    Structure:
    ```swift
    import SwiftUI

    struct EventListView: View {
        @EnvironmentObject private var appState: AppState
        var onEventTap: (Event) -> Void = { _ in }

        var body: some View {
            // Main content logic
        }
    }
    ```

    Content logic (per CONTEXT.md):

    1. If no events at all: Show "All clear" centered text

    2. If today has events:
       - Group all-day events at top (if any)
       - Divider between all-day and timed (if both exist)
       - Timed events below

    3. If no events today but tomorrow has events:
       - Show "Tomorrow" header (Text, font .caption, secondary color)
       - Show tomorrow's events

    Use VStack with ForEach (not List):
    ```swift
    VStack(spacing: 0) {
        ForEach(allDayEvents) { event in
            EventRowView(event: event, onTap: { onEventTap(event) })
        }
        if !allDayEvents.isEmpty && !timedEvents.isEmpty {
            Divider()
                .padding(.horizontal, 12)
        }
        ForEach(timedEvents) { event in
            EventRowView(event: event, onTap: { onEventTap(event) })
        }
    }
    ```

    Tomorrow detection:
    - Create helper to check if all events are tomorrow
    - Compare event.startDate to Calendar.current.isDateInTomorrow()
    - When showing tomorrow, add header:
      ```swift
      Text("Tomorrow")
          .font(.caption)
          .foregroundStyle(.secondary)
          .frame(maxWidth: .infinity, alignment: .leading)
          .padding(.horizontal, 12)
          .padding(.vertical, 4)
      ```

    No explicit height constraint - let VStack size naturally (grow-to-fit per CONTEXT.md).
  </action>
  <verify>
    File exists and compiles:
    ```
    ls ToEvent/ToEvent/Views/EventListView.swift
    cd ToEvent && xcodebuild -scheme ToEvent -configuration Debug build 2>&1 | tail -20
    ```
  </verify>
  <done>EventListView shows grouped events with all-day section, timed section, tomorrow fallback, and empty state</done>
</task>

<task type="auto">
  <name>Task 3: Update MenuBarView with EventListView and Footer</name>
  <files>ToEvent/ToEvent/Views/MenuBarView.swift</files>
  <action>
    Refactor MenuBarView to use EventListView and add proper footer.

    New structure:
    ```swift
    struct MenuBarView: View {
        @EnvironmentObject private var appState: AppState
        @State private var isRefreshing = false

        var body: some View {
            VStack(spacing: 0) {
                // Event list (grow-to-fit)
                EventListView(onEventTap: openEventInCalendar)

                Divider()

                // Fixed footer bar
                footerBar
            }
            .frame(width: 280)
            .fixedSize(horizontal: false, vertical: true)
        }
    }
    ```

    Footer bar (per CONTEXT.md):
    ```swift
    private var footerBar: some View {
        HStack {
            Button(action: openSettings) {
                Image(systemName: "gear")
            }
            .buttonStyle(.plain)
            .help("Settings")

            Spacer()

            Button(action: refresh) {
                Image(systemName: "arrow.clockwise")
                    .rotationEffect(.degrees(isRefreshing ? 360 : 0))
            }
            .buttonStyle(.plain)
            .help("Refresh")
        }
        .padding(.horizontal, 12)
        .padding(.vertical, 8)
    }
    ```

    Refresh action:
    ```swift
    private func refresh() {
        withAnimation(.linear(duration: 0.5)) {
            isRefreshing = true
        }
        appState.refreshEvents()
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
            isRefreshing = false
        }
    }
    ```

    openEventInCalendar placeholder (implemented in Plan 03):
    ```swift
    private func openEventInCalendar(_ event: Event) {
        // Will be implemented in Plan 03 with AppleScript
        print("Open event: \(event.title)")
    }
    ```

    openSettings - keep existing implementation from current MenuBarView.

    Remove:
    - The old TimelineView-based eventContent
    - The Settings/Quit text buttons (replaced by gear icon; Quit can stay or move to Settings pane)

    Decision on Quit: Per Claude's Discretion in CONTEXT.md, move Quit to Settings pane only (cleaner footer with just gear + refresh). Users expect Cmd+Q anyway.
  </action>
  <verify>
    Build succeeds:
    ```
    cd ToEvent && xcodebuild -scheme ToEvent -configuration Debug build 2>&1 | tail -20
    ```

    Run app and verify dropdown shows event list:
    ```
    cd ToEvent && xcodebuild -scheme ToEvent -configuration Debug build && open build/Debug/ToEvent.app
    ```
    (Manual verification: click menu bar, see events, hover rows for highlight)
  </verify>
  <done>MenuBarView shows EventListView with all events, footer has gear and refresh buttons, dropdown grows to fit content</done>
</task>

</tasks>

<verification>
1. Build succeeds without warnings
2. EventRowView.swift exists with proper button styling
3. EventListView.swift exists with VStack-based layout
4. MenuBarView uses EventListView and has footer bar
5. Hovering over rows shows subtle highlight
6. All-day events grouped at top (if any)
7. Empty state shows "All clear"
</verification>

<success_criteria>
- Dropdown shows list of upcoming events
- Each event shows title, calendar color dot, time/countdown
- All-day events grouped at top
- Tomorrow fallback when no events today
- Footer has gear and refresh buttons
- Refresh button spins when clicked
- Rows highlight on hover
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-dropdown-event-list/03-02-SUMMARY.md`
</output>
