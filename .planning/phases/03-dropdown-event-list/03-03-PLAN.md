---
phase: 03-dropdown-event-list
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - ToEvent/ToEvent/Views/MenuBarView.swift
  - ToEvent/ToEvent/ToEvent.entitlements
  - ToEvent/ToEvent/Info.plist
autonomous: true

must_haves:
  truths:
    - "Clicking event opens it in macOS Calendar app"
    - "AppleScript automation permissions are properly configured"
    - "Calendar app activates and shows the specific event"
  artifacts:
    - path: "ToEvent/ToEvent/ToEvent.entitlements"
      provides: "AppleScript automation entitlement"
      contains: "com.apple.security.automation.apple-events"
    - path: "ToEvent/ToEvent/Info.plist"
      provides: "Automation usage description"
      contains: "NSAppleEventsUsageDescription"
    - path: "ToEvent/ToEvent/Views/MenuBarView.swift"
      provides: "openEventInCalendar implementation"
      contains: "NSAppleScript"
  key_links:
    - from: "EventRowView onTap"
      to: "openEventInCalendar"
      via: "closure passed through EventListView"
      pattern: "onEventTap.*openEventInCalendar"
---

<objective>
Implement AppleScript integration to open events in macOS Calendar app.

Purpose: Users should be able to click any event in the dropdown and have it open in Calendar.app for full details. This is the primary interaction beyond viewing.

Output: Working event click action that opens Calendar.app and navigates to the event.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dropdown-event-list/03-RESEARCH.md
@.planning/phases/03-dropdown-event-list/03-02-SUMMARY.md

# Source files
@ToEvent/ToEvent/Views/MenuBarView.swift
@ToEvent/ToEvent/ToEvent.entitlements
@ToEvent/ToEvent/Info.plist
@ToEvent/ToEvent/Models/Event.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AppleScript automation entitlements</name>
  <files>
    ToEvent/ToEvent/ToEvent.entitlements
    ToEvent/ToEvent/Info.plist
  </files>
  <action>
    Configure app for AppleScript automation to Calendar.app.

    In ToEvent.entitlements, add:
    ```xml
    <key>com.apple.security.automation.apple-events</key>
    <true/>
    ```

    In Info.plist, add usage description:
    ```xml
    <key>NSAppleEventsUsageDescription</key>
    <string>ToEvent needs to open events in Calendar app when you click them.</string>
    ```

    Note: If entitlements file doesn't exist yet, it may need to be created. Check first:
    ```
    ls ToEvent/ToEvent/ToEvent.entitlements
    ```

    If it doesn't exist, create it with standard sandbox entitlements plus automation:
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
        <key>com.apple.security.app-sandbox</key>
        <true/>
        <key>com.apple.security.personal-information.calendars</key>
        <true/>
        <key>com.apple.security.automation.apple-events</key>
        <true/>
    </dict>
    </plist>
    ```

    Verify Info.plist already has NSCalendarsUsageDescription (should exist from Phase 1).
  </action>
  <verify>
    Check entitlements:
    ```
    grep -A1 "automation.apple-events" ToEvent/ToEvent/ToEvent.entitlements
    ```

    Check Info.plist:
    ```
    grep -A1 "NSAppleEventsUsageDescription" ToEvent/ToEvent/Info.plist
    ```

    Build succeeds:
    ```
    cd ToEvent && xcodebuild -scheme ToEvent -configuration Debug build 2>&1 | tail -20
    ```
  </verify>
  <done>Entitlements include automation.apple-events, Info.plist has usage description</done>
</task>

<task type="auto">
  <name>Task 2: Implement openEventInCalendar with AppleScript</name>
  <files>ToEvent/ToEvent/Views/MenuBarView.swift</files>
  <action>
    Replace the placeholder openEventInCalendar with AppleScript implementation.

    Per RESEARCH.md, AppleScript is the only reliable way to open specific events. The `show` command requires calendar title and event UID.

    Implementation:
    ```swift
    private func openEventInCalendar(_ event: Event) {
        // Escape quotes in calendar title to prevent AppleScript injection
        let escapedTitle = event.calendarTitle.replacingOccurrences(of: "\"", with: "\\\"")
        let escapedEventID = event.id.replacingOccurrences(of: "\"", with: "\\\"")

        let script = """
        tell application "Calendar"
            tell calendar "\(escapedTitle)"
                show (first event where its uid = "\(escapedEventID)")
            end tell
            activate
        end tell
        """

        var error: NSDictionary?
        if let scriptObject = NSAppleScript(source: script) {
            scriptObject.executeAndReturnError(&error)
            if let error = error {
                // Log error but don't show to user - Calendar app likely opened anyway
                print("AppleScript error: \(error)")
            }
        }
    }
    ```

    Add Foundation import if not present (for NSAppleScript).

    Fallback behavior: If AppleScript fails (e.g., calendar renamed, event deleted), Calendar.app should still activate. The error is logged but not surfaced to user.

    Testing note: First run will trigger macOS automation permission dialog. User must grant "ToEvent wants to control Calendar.app" permission.
  </action>
  <verify>
    Build succeeds:
    ```
    cd ToEvent && xcodebuild -scheme ToEvent -configuration Debug build 2>&1 | tail -20
    ```

    Grep for implementation:
    ```
    grep -n "NSAppleScript" ToEvent/ToEvent/Views/MenuBarView.swift
    ```
  </verify>
  <done>Clicking event row opens Calendar.app and shows the event (with automation permission granted)</done>
</task>

</tasks>

<verification>
1. Build succeeds without warnings
2. ToEvent.entitlements has automation.apple-events key
3. Info.plist has NSAppleEventsUsageDescription
4. MenuBarView.openEventInCalendar uses NSAppleScript
5. Clicking event opens Calendar app (requires running app and testing)
</verification>

<success_criteria>
- Automation entitlements properly configured
- Usage description explains why automation is needed
- Clicking event row triggers AppleScript
- Calendar.app opens and shows the clicked event
- No crash if calendar or event not found (graceful fallback)
</success_criteria>

<output>
After completion, create `.planning/phases/03-dropdown-event-list/03-03-SUMMARY.md`
</output>
