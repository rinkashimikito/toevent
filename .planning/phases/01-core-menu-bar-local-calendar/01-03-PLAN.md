---
phase: 01-core-menu-bar-local-calendar
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - ToEvent/Views/Settings/CalendarSettingsView.swift
  - ToEvent/Views/Settings/GeneralSettingsView.swift
  - ToEvent/ToEventApp.swift
  - ToEvent/ToEvent.xcodeproj (package dependency)
autonomous: false

must_haves:
  truths:
    - "User can open settings from the app"
    - "User can see list of all calendars with toggles"
    - "User can disable specific calendars (opt-out)"
    - "Disabled calendars are excluded from next event calculation"
    - "Calendar preferences persist across app restarts"
  artifacts:
    - path: "ToEvent/Views/Settings/CalendarSettingsView.swift"
      provides: "Calendar selection UI"
      contains: "Toggle"
    - path: "ToEvent/Views/Settings/GeneralSettingsView.swift"
      provides: "General settings tab"
      contains: "lookahead"
  key_links:
    - from: "CalendarSettingsView.swift"
      to: "AppState.enabledCalendarIDs"
      via: "Binding"
      pattern: "enabledCalendarIDs"
    - from: "CalendarSettingsView.swift"
      to: "CalendarService.getCalendars"
      via: "Calendar list fetch"
      pattern: "CalendarService\\.shared\\.getCalendars"
    - from: "ToEventApp.swift"
      to: "Settings scene"
      via: "sindresorhus/Settings"
      pattern: "Settings\\s*\\{"
---

<objective>
Add calendar settings using sindresorhus/Settings package, allowing users to select which calendars appear in the menu bar.

Purpose: Delivers requirement CALD-03 (opt-out specific calendars) and completes Phase 1 user-facing features.
Output: Working preferences window with calendar toggles and general settings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-menu-bar-local-calendar/01-RESEARCH.md
@.planning/phases/01-core-menu-bar-local-calendar/01-CONTEXT.md
@.planning/phases/01-core-menu-bar-local-calendar/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sindresorhus/Settings and create settings views</name>
  <files>
    ToEvent/ToEvent.xcodeproj
    ToEvent/Views/Settings/CalendarSettingsView.swift
    ToEvent/Views/Settings/GeneralSettingsView.swift
  </files>
  <action>
Add sindresorhus/Settings package dependency:
- URL: https://github.com/sindresorhus/Settings
- Version: 3.1.0 or latest
- Add via Xcode File > Add Package Dependencies, or modify Package.swift if using SPM

Create CalendarSettingsView.swift:
- Conform to Settings.Pane protocol (from sindresorhus/Settings)
- paneIdentifier: "calendars"
- paneTitle: "Calendars"
- paneIcon: NSImage(systemSymbolName: "calendar")
- Content:
  - List of all calendars from CalendarService.shared.getCalendars()
  - Group by source (account) if multiple accounts exist
  - Each calendar row: Toggle with calendar title, colored circle indicator
  - Toggle binding: when ON, calendar ID is in enabledCalendarIDs (or enabledCalendarIDs is nil meaning all)
  - When OFF, calendar ID is removed from set
- Logic for opt-out model:
  - If enabledCalendarIDs is nil, all are enabled (show all toggles ON)
  - First time user disables one: create Set with all IDs except the disabled one
  - If user re-enables all: set back to nil (all enabled)
- Persist changes to UserDefaults via AppState

Create GeneralSettingsView.swift:
- Conform to Settings.Pane protocol
- paneIdentifier: "general"
- paneTitle: "General"
- paneIcon: NSImage(systemSymbolName: "gear")
- Content:
  - Lookahead picker: 1h, 6h, 12h, 24h, 48h, 7d options
  - Bound to appState.lookahead
  - Label: "Show events in the next:"
- Include placeholder for future settings (icon toggle, etc.) with disabled state or comment
  </action>
  <verify>
Build succeeds with Settings package. Settings views conform to Pane protocol. CalendarSettingsView shows calendar list.
  </verify>
  <done>
Settings package integrated. CalendarSettingsView shows calendar list with toggles. GeneralSettingsView has lookahead picker.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Settings into app and add access point</name>
  <files>
    ToEvent/ToEventApp.swift
    ToEvent/Views/MenuBarView.swift
  </files>
  <action>
Update ToEventApp.swift:
- Add Settings scene using sindresorhus/Settings pattern
- Register CalendarSettingsView and GeneralSettingsView as panes
- Settings should be accessible via standard macOS Cmd+, shortcut

Add settings access from MenuBarView:
- Add a "Settings..." button or gear icon at bottom of menu bar window content
- Use SettingsLink (from sindresorhus/Settings) or NSApp.sendAction for Settings selector
- Alternative: Add a simple "Preferences" button that opens settings window

Add Quit option:
- Since LSUIElement hides dock, user needs way to quit
- Add "Quit ToEvent" button in menu bar window
- Use NSApplication.shared.terminate(nil)

MenuBarView structure after changes:
```
VStack {
  [event display - existing]
  Divider()
  HStack {
    Button("Settings...") { open settings }
    Spacer()
    Button("Quit") { NSApplication.shared.terminate(nil) }
  }
}
```

Verify Settings opens correctly from menu bar (this is the known pitfall area).
  </action>
  <verify>
1. Click gear/Settings button in menu bar dropdown - Settings window opens
2. Cmd+, shortcut opens Settings
3. Calendar toggles work and persist
4. Quit button terminates app
  </verify>
  <done>
Settings accessible from menu bar. Calendar selection persists. Quit option available.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 1: Menu bar app with calendar permissions, next event display, and calendar settings.
  </what-built>
  <how-to-verify>
1. Build and run the app (delete app container first for fresh state)
2. Verify intro screen appears on first launch
3. Click "Get Started" and grant calendar permission
4. Verify menu bar shows your next upcoming event with:
   - Colored dot (matching calendar color)
   - Event title (truncated if long)
   - Relative time (e.g., "in 45m")
5. If you have an all-day event, verify it shows "Today" not a countdown
6. If no events, verify "All clear" appears
7. Open Settings (click gear or Cmd+,)
8. Verify calendar list shows all your calendars
9. Toggle OFF a calendar and verify that calendar's events no longer appear
10. Toggle it back ON and verify events return
11. Change lookahead setting and verify behavior
12. Switch between light/dark mode and verify readability
13. Click Quit and verify app terminates
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Settings window opens from menu bar without issue
2. Calendar list populates with all user calendars
3. Toggle changes persist across app restart
4. Disabling a calendar excludes its events from next event calculation
5. Lookahead changes affect which events are considered
6. Cmd+, opens Settings (standard macOS behavior)
7. Quit button works
</verification>

<success_criteria>
- User can open settings from menu bar UI
- User sees all calendars organized by account/source
- User can toggle individual calendars off (opt-out model)
- Toggled-off calendars are excluded from next event display
- Lookahead setting controls event fetch window
- Preferences persist across app restarts (UserDefaults)
- Standard macOS keyboard shortcuts work (Cmd+, for Settings)
- User can quit the app from menu bar UI
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-menu-bar-local-calendar/01-03-SUMMARY.md`
</output>
