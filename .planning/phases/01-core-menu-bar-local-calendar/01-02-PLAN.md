---
phase: 01-core-menu-bar-local-calendar
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - ToEvent/State/AppState.swift
  - ToEvent/Views/MenuBarView.swift
  - ToEvent/Views/IntroView.swift
  - ToEvent/Utilities/DateFormatters.swift
  - ToEvent/ToEventApp.swift
autonomous: true

must_haves:
  truths:
    - "User sees intro screen on first launch before permission request"
    - "User can grant calendar permissions through intro screen"
    - "User sees next event title with relative time in menu bar"
    - "All-day events show 'Today' instead of countdown"
    - "Menu bar shows 'All clear' when no upcoming events"
  artifacts:
    - path: "ToEvent/State/AppState.swift"
      provides: "Observable app state"
      contains: "@Observable"
    - path: "ToEvent/Views/MenuBarView.swift"
      provides: "Menu bar content view"
      contains: "TimelineView"
    - path: "ToEvent/Views/IntroView.swift"
      provides: "Permission request intro"
      contains: "requestAccess"
    - path: "ToEvent/Utilities/DateFormatters.swift"
      provides: "Relative time formatting"
      contains: "DateComponentsFormatter"
  key_links:
    - from: "MenuBarView.swift"
      to: "AppState"
      via: "Environment injection"
      pattern: "@Environment.*AppState"
    - from: "MenuBarView.swift"
      to: "CalendarService"
      via: "Event fetching through AppState"
      pattern: "appState\\.nextEvent"
    - from: "IntroView.swift"
      to: "CalendarService"
      via: "Permission request"
      pattern: "CalendarService\\.shared\\.requestAccess"
---

<objective>
Implement the menu bar display showing the next event with relative time, plus the intro/permission flow for first-time users.

Purpose: Delivers the core user-facing functionality - seeing the next event in the menu bar.
Output: Working menu bar display with event title, colored dot, relative time, and proper permission handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-menu-bar-local-calendar/01-RESEARCH.md
@.planning/phases/01-core-menu-bar-local-calendar/01-CONTEXT.md
@.planning/phases/01-core-menu-bar-local-calendar/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppState and DateFormatters</name>
  <files>
    ToEvent/State/AppState.swift
    ToEvent/Utilities/DateFormatters.swift
  </files>
  <action>
Create DateFormatters.swift:
- Function `formatRelativeTime(until date: Date, from now: Date) -> String`
- Use DateComponentsFormatter with .abbreviated unitsStyle
- allowedUnits: [.hour, .minute]
- maximumUnitCount: 1 (shows "45m" not "45m 30s")
- Return "in X" format (e.g., "in 45m", "in 2h")
- Return "now" if interval <= 0
- Handle edge case of very short intervals gracefully

Create AppState.swift:
- Use @Observable macro (requires macOS 14+, add @available check or use @StateObject pattern for macOS 13)
- Properties:
  - `var hasCompletedIntro: Bool` - persisted to UserDefaults
  - `var authorizationStatus: EKAuthorizationStatus` - computed from CalendarService
  - `var nextEvent: Event?` - the next upcoming event
  - `var enabledCalendarIDs: Set<String>?` - nil means all enabled (opt-out model), persisted to UserDefaults
  - `var lookahead: TimeInterval` - default 86400 (24 hours), persisted to UserDefaults
- Method: `func refreshEvents()` - fetches events using CalendarService, filters by enabledCalendarIDs, sets nextEvent to first non-past event
- Subscribe to CalendarService.lastRefresh to auto-refresh when calendar changes
- On init, check hasCompletedIntro and load persisted preferences
  </action>
  <verify>
Build succeeds. AppState can be instantiated. DateFormatters.formatRelativeTime returns expected strings.
  </verify>
  <done>
AppState observable created with event state management. DateFormatters provides relative time strings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement MenuBarView with TimelineView</name>
  <files>
    ToEvent/Views/MenuBarView.swift
    ToEvent/ToEventApp.swift
  </files>
  <action>
Create MenuBarView.swift:
- Use TimelineView with .periodic(from: .now, by: 60) for minute updates
- Get AppState from @Environment
- Display logic:
  - If no event (nextEvent is nil): show "All clear" text
  - If event.isAllDay: show "[colored dot] [title] - Today"
  - Otherwise: show "[colored dot] [title] [in Xm]" using formatRelativeTime
- Colored dot: Circle() with fill(Color(cgColor:)) from event.calendarColor, size 8x8
- Title truncation: limit to ~22 characters with "..." ellipsis
- Use .lineLimit(1) to prevent wrapping
- Use .foregroundStyle(.primary) for automatic light/dark mode
- HStack layout with spacing

Update ToEventApp.swift:
- Create AppState instance at app level
- Inject AppState into environment for MenuBarView
- Replace placeholder with MenuBarView
- Add conditional logic: if !appState.hasCompletedIntro, show intro window instead (or alongside)

Consider: On first launch, MenuBarExtra might show "All clear" until permission granted. This is acceptable - intro window will guide user.
  </action>
  <verify>
Build and run. Menu bar shows "All clear" initially (no permission yet). TimelineView updates work (verify by checking CPU usage is minimal).
  </verify>
  <done>
Menu bar displays event information with colored dot, title, and relative time. Updates every minute via TimelineView. Shows "All clear" when no events.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement IntroView with permission flow</name>
  <files>
    ToEvent/Views/IntroView.swift
    ToEvent/ToEventApp.swift
  </files>
  <action>
Create IntroView.swift:
- Window-style view (will be shown in a separate window)
- Content:
  - App icon or calendar symbol at top
  - Headline: "Never miss a meeting" (or similar)
  - Body text explaining value proposition: ToEvent shows your next calendar event in the menu bar so you always know what's coming up.
  - "Get Started" button that:
    1. Calls CalendarService.shared.requestAccess() async
    2. Sets appState.hasCompletedIntro = true
    3. Calls appState.refreshEvents()
    4. Dismisses the window
- If permission denied after request:
  - Show different state with "Open Settings" button
  - "Open Settings" calls NSWorkspace.shared.open with x-apple.systempreferences URL for calendar privacy
- Use @Environment(\.dismiss) for window dismissal
- Frame constraints for reasonable window size (~300 width)

Update ToEventApp.swift:
- Add Window scene for intro (or use .windowStyle)
- Show intro window if !appState.hasCompletedIntro on launch
- Use openWindow environment action or NSApp.activate pattern
- After intro completed, focus returns to menu bar presence

Implementation note: MenuBarExtra with .window style + separate Window scene may need careful handling. Consider using Settings scene for intro if Window scene causes issues, OR use a sheet/popover from the MenuBarExtra window itself.
  </action>
  <verify>
Fresh launch (delete UserDefaults): intro window appears. Click "Get Started" - permission dialog appears. After granting, intro closes, menu bar shows events.
  </verify>
  <done>
Intro screen appears on first launch. Permission request triggers from intro. After permission granted, events appear in menu bar. Denied state shows Settings link.
  </done>
</task>

</tasks>

<verification>
1. Fresh launch: intro window appears before menu bar shows real data
2. Click "Get Started": macOS permission dialog appears
3. After granting permission: menu bar shows next event with "[dot] Title in Xm" format
4. If no events: menu bar shows "All clear"
5. All-day event (if one exists): shows "Title - Today"
6. Title truncation works for long event titles
7. Menu bar adapts to light/dark mode (text color changes)
8. App uses minimal CPU (TimelineView updates, not continuous timer)
</verification>

<success_criteria>
- User sees intro screen on first launch explaining the app
- User can grant calendar permissions through the intro flow
- After permission, menu bar displays: colored dot + event title + relative time
- All-day events show "Today" instead of time countdown
- "All clear" shown when no upcoming events within lookahead
- Menu bar text is readable in both light and dark mode
- Intro only shows once (persisted via UserDefaults)
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-menu-bar-local-calendar/01-02-SUMMARY.md`
</output>
