---
phase: 06-meeting-links-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ToEvent/ToEvent/Models/Event.swift
  - ToEvent/ToEvent/Models/GoogleAPIModels.swift
  - ToEvent/ToEvent/Models/MicrosoftAPIModels.swift
  - ToEvent/ToEvent/Services/MeetingURLParser.swift
  - ToEvent/ToEvent/Services/LocalCalendarProvider.swift
  - ToEvent/ToEvent/Services/EventCacheService.swift
autonomous: true

must_haves:
  truths:
    - "Events from all sources include location, meeting URL, and notes fields"
    - "Meeting URLs are automatically detected from event description/notes/location"
    - "Zoom, Google Meet, Teams, and Webex URLs are recognized"
  artifacts:
    - path: "ToEvent/ToEvent/Models/Event.swift"
      provides: "Extended Event with location, meetingURL, notes, url"
      contains: "let meetingURL: URL?"
    - path: "ToEvent/ToEvent/Services/MeetingURLParser.swift"
      provides: "Regex-based meeting URL detection"
      exports: ["MeetingURLParser"]
  key_links:
    - from: "GoogleAPIModels.swift"
      to: "Event.swift"
      via: "toEvent() passes location, hangoutLink, conferenceData"
      pattern: "meetingURL.*hangoutLink"
    - from: "MicrosoftAPIModels.swift"
      to: "Event.swift"
      via: "toEvent() passes location, onlineMeeting.joinUrl"
      pattern: "meetingURL.*joinUrl"
---

<objective>
Extend the Event model with location, meeting URL, and notes fields, and create a parser to detect meeting URLs from text.

Purpose: Foundation for event actions (join meeting, get directions, copy details). All other Phase 6 features depend on these fields.
Output: Extended Event model, MeetingURLParser service, updated API models
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-meeting-links-notifications/06-RESEARCH.md
@ToEvent/ToEvent/Models/Event.swift
@ToEvent/ToEvent/Models/GoogleAPIModels.swift
@ToEvent/ToEvent/Models/MicrosoftAPIModels.swift
@ToEvent/ToEvent/Services/LocalCalendarProvider.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Event model with action-related fields</name>
  <files>ToEvent/ToEvent/Models/Event.swift</files>
  <action>
Add new fields to Event struct:
- `let location: String?` - Free-form location text
- `let meetingURL: URL?` - Detected or explicit meeting URL
- `let notes: String?` - Event notes/description for URL parsing
- `let url: URL?` - Event's explicit URL property

Update both initializers:
1. Main init: Add all four parameters with default nil values
2. EKEvent init: Extract from EKEvent properties:
   - location from ekEvent.location
   - meetingURL: First try ekEvent.url, then parse notes/location with MeetingURLParser.findMeetingURL()
   - notes from ekEvent.notes
   - url from ekEvent.url

Import Foundation at top for URL type.
  </action>
  <verify>Build succeeds with `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build`</verify>
  <done>Event struct has location, meetingURL, notes, url fields; EKEvent initializer extracts these from EventKit</done>
</task>

<task type="auto">
  <name>Task 2: Create MeetingURLParser service</name>
  <files>ToEvent/ToEvent/Services/MeetingURLParser.swift</files>
  <action>
Create MeetingURLParser with static methods:

```swift
import Foundation

struct MeetingURLParser {
    static let patterns: [(name: String, regex: String)] = [
        ("Zoom", #"https?://([a-z0-9]+\.)?zoom(gov)?\.us/(j|my|w)/[a-zA-Z0-9/?=&-]+"#),
        ("Google Meet", #"https?://meet\.google\.com/[a-z]+-[a-z]+-[a-z]+"#),
        ("Microsoft Teams", #"https?://teams\.microsoft\.com/l/meetup-join/[^\s]+"#),
        ("Webex", #"https?://([a-z0-9]+\.)?webex\.com/[^\s]+"#)
    ]

    /// Find meeting URL in text (notes, description, location)
    static func findMeetingURL(in text: String?) -> URL? {
        guard let text = text, !text.isEmpty else { return nil }

        for (_, pattern) in patterns {
            if let regex = try? NSRegularExpression(pattern: pattern, options: .caseInsensitive),
               let match = regex.firstMatch(in: text, range: NSRange(text.startIndex..., in: text)),
               let range = Range(match.range, in: text) {
                let urlString = String(text[range])
                return URL(string: urlString)
            }
        }
        return nil
    }

    /// Check multiple sources and return first meeting URL found
    static func findMeetingURL(url: URL?, location: String?, notes: String?) -> URL? {
        // Explicit URL takes priority if it looks like a meeting URL
        if let url = url, isMeetingURL(url) {
            return url
        }
        // Then check location field (often contains meeting URLs)
        if let found = findMeetingURL(in: location) {
            return found
        }
        // Finally check notes/description
        return findMeetingURL(in: notes)
    }

    /// Check if URL matches known meeting patterns
    static func isMeetingURL(_ url: URL) -> Bool {
        let urlString = url.absoluteString
        return patterns.contains { _, pattern in
            (try? NSRegularExpression(pattern: pattern, options: .caseInsensitive))?
                .firstMatch(in: urlString, range: NSRange(urlString.startIndex..., in: urlString)) != nil
        }
    }
}
```

Add file to Xcode project in Services group.
  </action>
  <verify>Build succeeds; MeetingURLParser.findMeetingURL(in: "Join at https://meet.google.com/abc-def-ghi") returns valid URL</verify>
  <done>MeetingURLParser detects Zoom, Google Meet, Teams, Webex URLs from text</done>
</task>

<task type="auto">
  <name>Task 3: Update Google and Microsoft API models</name>
  <files>ToEvent/ToEvent/Models/GoogleAPIModels.swift, ToEvent/ToEvent/Models/MicrosoftAPIModels.swift</files>
  <action>
**GoogleAPIModels.swift:**

1. Add missing fields to GoogleEvent:
```swift
struct GoogleEvent: Codable {
    let id: String
    let summary: String?
    let start: GoogleEventDateTime
    let end: GoogleEventDateTime
    let status: String?
    let location: String?           // NEW
    let description: String?        // NEW (notes)
    let hangoutLink: String?        // NEW (Google Meet URL)
    let htmlLink: String?           // NEW (calendar event URL)
}
```

2. Update toEvent() to pass new fields:
```swift
func toEvent(...) -> Event? {
    // ... existing validation ...

    let meetingURL: URL?
    if let hangout = hangoutLink {
        meetingURL = URL(string: hangout)
    } else {
        meetingURL = MeetingURLParser.findMeetingURL(
            url: nil,
            location: location,
            notes: description
        )
    }

    return Event(
        // ... existing fields ...
        location: location,
        meetingURL: meetingURL,
        notes: description,
        url: htmlLink.flatMap { URL(string: $0) }
    )
}
```

**MicrosoftAPIModels.swift:**

1. Add missing fields to MicrosoftEvent:
```swift
struct MicrosoftEvent: Codable {
    let id: String
    let subject: String?
    let start: MicrosoftDateTime
    let end: MicrosoftDateTime
    let isAllDay: Bool?
    let isCancelled: Bool?
    let location: MicrosoftLocation?   // NEW
    let body: MicrosoftBody?           // NEW (notes)
    let onlineMeeting: MicrosoftOnlineMeeting?  // NEW
    let webLink: String?               // NEW (calendar event URL)
}

struct MicrosoftLocation: Codable {
    let displayName: String?
}

struct MicrosoftBody: Codable {
    let content: String?
    let contentType: String?  // "html" or "text"
}

struct MicrosoftOnlineMeeting: Codable {
    let joinUrl: String?
}
```

2. Update toEvent():
```swift
func toEvent(...) -> Event {
    let locationText = location?.displayName

    let meetingURL: URL?
    if let joinUrl = onlineMeeting?.joinUrl {
        meetingURL = URL(string: joinUrl)
    } else {
        meetingURL = MeetingURLParser.findMeetingURL(
            url: nil,
            location: locationText,
            notes: body?.content
        )
    }

    return Event(
        // ... existing fields ...
        location: locationText,
        meetingURL: meetingURL,
        notes: body?.content,
        url: webLink.flatMap { URL(string: $0) }
    )
}
```
  </action>
  <verify>Build succeeds with extended API models</verify>
  <done>Google events extract hangoutLink/conferenceData; Microsoft events extract onlineMeeting.joinUrl</done>
</task>

</tasks>

<verification>
1. Build: `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build`
2. Event model has all four new fields
3. MeetingURLParser.swift exists in Services
4. Google/Microsoft API models include location and meeting fields
</verification>

<success_criteria>
- Event struct extended with location, meetingURL, notes, url (all optional)
- MeetingURLParser detects Zoom, Google Meet, Teams, Webex patterns
- EKEvent init extracts location/notes and parses for meeting URLs
- Google API model extracts hangoutLink and location
- Microsoft API model extracts onlineMeeting.joinUrl and location
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-meeting-links-notifications/06-01-SUMMARY.md`
</output>
