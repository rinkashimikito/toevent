---
phase: 06-meeting-links-notifications
plan: 06
type: execute
wave: 3
depends_on: ["06-01"]
files_modified:
  - ToEvent/ToEvent/Intent/ToEventFocusFilter.swift
  - ToEvent/ToEvent/State/AppState.swift
  - ToEvent/ToEvent/Views/MenuBarView.swift
  - ToEvent/ToEvent/Views/QuickAddView.swift
autonomous: true

must_haves:
  truths:
    - "User can configure Focus filter to show only specific calendars"
    - "Focus mode filter applies automatically when Focus is active"
    - "User can quick-add event from dropdown menu"
    - "Quick-add opens Calendar app with new event"
  artifacts:
    - path: "ToEvent/ToEvent/Intent/ToEventFocusFilter.swift"
      provides: "SetFocusFilterIntent for Focus mode integration"
      contains: "SetFocusFilterIntent"
    - path: "ToEvent/ToEvent/Views/QuickAddView.swift"
      provides: "Quick-add event button/sheet"
  key_links:
    - from: "ToEventFocusFilter.swift"
      to: "AppState.swift"
      via: "writes to UserDefaults.focusFilterCalendars"
      pattern: "focusFilterCalendars"
    - from: "AppState.swift"
      to: "events filtering"
      via: "applies focus filter when active"
---

<objective>
Add Focus mode integration with FocusFilterIntent and quick-add event functionality.

Purpose: Implements SYST-03 (Focus mode filtering) and ACTN-05 (quick-add event).
Output: ToEventFocusFilter intent, AppState focus filtering, QuickAddView
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-meeting-links-notifications/06-RESEARCH.md
@.planning/phases/06-meeting-links-notifications/06-01-SUMMARY.md
@ToEvent/ToEvent/State/AppState.swift
@ToEvent/ToEvent/Views/MenuBarView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ToEventFocusFilter intent</name>
  <files>ToEvent/ToEvent/Intent/ToEventFocusFilter.swift</files>
  <action>
Create the FocusFilter intent that allows users to configure which calendars appear during a Focus mode:

```swift
import AppIntents

@available(macOS 13.0, *)
struct ToEventFocusFilter: SetFocusFilterIntent {
    static var title: LocalizedStringResource = "ToEvent Focus Filter"
    static var description: IntentDescription? = IntentDescription(
        "Filter which calendars appear in ToEvent during this Focus"
    )

    @Parameter(title: "Show only calendars")
    var enabledCalendarNames: [String]?

    @Parameter(title: "Hide all events")
    var hideAllEvents: Bool?

    func perform() async throws -> some IntentResult {
        // Save filter state for AppState to read
        if hideAllEvents == true {
            UserDefaults.standard.set(true, forKey: "focusHideAllEvents")
            UserDefaults.standard.removeObject(forKey: "focusFilterCalendars")
        } else if let calendars = enabledCalendarNames, !calendars.isEmpty {
            UserDefaults.standard.set(calendars, forKey: "focusFilterCalendars")
            UserDefaults.standard.set(false, forKey: "focusHideAllEvents")
        } else {
            // No filter - show all
            UserDefaults.standard.removeObject(forKey: "focusFilterCalendars")
            UserDefaults.standard.set(false, forKey: "focusHideAllEvents")
        }

        // Post notification for AppState to pick up
        NotificationCenter.default.post(name: .focusFilterChanged, object: nil)

        return .result()
    }
}

extension Notification.Name {
    static let focusFilterChanged = Notification.Name("focusFilterChanged")
}
```

Create the Intent directory if it doesn't exist. Add file to Xcode project in a new Intent group.

Note: This requires adding AppIntents framework to the project if not already present.
  </action>
  <verify>Build succeeds with ToEventFocusFilter (may require macOS 13+ deployment)</verify>
  <done>FocusFilterIntent allows users to configure calendar filter per Focus mode</done>
</task>

<task type="auto">
  <name>Task 2: Add Focus filter support to AppState</name>
  <files>ToEvent/ToEvent/State/AppState.swift</files>
  <action>
Add Focus mode filtering to AppState:

1. Add computed property for filtered events:
```swift
/// Events filtered by Focus mode settings
var filteredEvents: [Event] {
    // Check if Focus mode wants to hide all
    if UserDefaults.standard.bool(forKey: "focusHideAllEvents") {
        return []
    }

    // Check if Focus mode has calendar filter
    if let focusCalendars = UserDefaults.standard.stringArray(forKey: "focusFilterCalendars"),
       !focusCalendars.isEmpty {
        return events.filter { event in
            focusCalendars.contains(event.calendarTitle)
        }
    }

    // No Focus filter - return all events
    return events
}
```

2. Add Focus filter observer in init() (inside the if hasCompletedIntro block):
```swift
NotificationCenter.default.addObserver(
    forName: .focusFilterChanged,
    object: nil,
    queue: .main
) { [weak self] _ in
    self?.objectWillChange.send()
}
```

3. Update the code that uses `events` to use `filteredEvents` where appropriate. The main places are:
   - `timedEvents` and `allDayEvents` - update to use filteredEvents as base
   - Or add separate filtered versions for UI display

Update the computed properties:
```swift
var allDayEvents: [Event] {
    filteredEvents.filter { $0.isAllDay }
}

var timedEvents: [Event] {
    filteredEvents.filter { !$0.isAllDay }
}
```

Note: Keep the raw `events` property for conflict detection (conflicts should consider all events regardless of Focus filter).
  </action>
  <verify>Build succeeds; filteredEvents applies Focus mode filter</verify>
  <done>AppState filters events based on Focus mode settings stored in UserDefaults</done>
</task>

<task type="auto">
  <name>Task 3: Create QuickAddView and integrate with dropdown</name>
  <files>ToEvent/ToEvent/Views/QuickAddView.swift, ToEvent/ToEvent/Views/MenuBarView.swift</files>
  <action>
**QuickAddView.swift:**

Create a simple quick-add that opens Calendar.app with a new event:

```swift
import SwiftUI
import EventKit

struct QuickAddView: View {
    @Environment(\.dismiss) private var dismiss
    @State private var title = ""
    @State private var startDate = Date().addingTimeInterval(3600) // Default 1 hour from now

    var body: some View {
        VStack(spacing: 16) {
            Text("Quick Add Event")
                .font(.headline)

            TextField("Event title", text: $title)
                .textFieldStyle(.roundedBorder)

            DatePicker(
                "Start time",
                selection: $startDate,
                displayedComponents: [.date, .hourAndMinute]
            )

            HStack {
                Button("Cancel") {
                    dismiss()
                }

                Spacer()

                Button("Add in Calendar") {
                    openInCalendarApp()
                    dismiss()
                }
                .buttonStyle(.borderedProminent)
                .disabled(title.isEmpty)
            }
        }
        .padding()
        .frame(width: 300)
    }

    private func openInCalendarApp() {
        // Format date for AppleScript
        let formatter = DateFormatter()
        formatter.dateFormat = "MMMM d, yyyy 'at' h:mm a"
        let dateString = formatter.string(from: startDate)

        let script = """
        tell application "Calendar"
            activate
            set newEvent to make new event at end of events of calendar 1 with properties {summary:"\(title.replacingOccurrences(of: "\"", with: "\\\""))", start date:date "\(dateString)"}
            show newEvent
        end tell
        """

        if let appleScript = NSAppleScript(source: script) {
            var error: NSDictionary?
            appleScript.executeAndReturnError(&error)
            if error != nil {
                // Fallback: just open Calendar app
                NSWorkspace.shared.open(URL(string: "x-apple-calendar://")!)
            }
        }
    }
}
```

Add file to Xcode project in Views group.

**MenuBarView.swift:**

Add quick-add button to the footer area (near the settings gear icon). Find the footer section and add:

1. Add state for showing quick-add:
```swift
@State private var showingQuickAdd = false
```

2. Add button in the footer HStack (before or after the settings button):
```swift
Button(action: { showingQuickAdd = true }) {
    Image(systemName: "plus.circle")
}
.buttonStyle(.borderless)
.help("Quick add event")
.popover(isPresented: $showingQuickAdd) {
    QuickAddView()
}
```
  </action>
  <verify>Build succeeds; plus button in footer opens QuickAddView popover</verify>
  <done>QuickAddView opens Calendar.app with new event; accessible from dropdown footer</done>
</task>

</tasks>

<verification>
1. Build: `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build`
2. ToEventFocusFilter.swift exists in Intent group
3. QuickAddView.swift exists in Views
4. AppState has filteredEvents that respects Focus mode settings
5. Dropdown footer has plus button that opens QuickAddView
6. Focus filter changes trigger UI refresh
</verification>

<success_criteria>
- ToEventFocusFilter intent configured with calendar name parameter
- Focus filter state stored in UserDefaults
- AppState.filteredEvents applies Focus filter to event list
- timedEvents and allDayEvents use filteredEvents as base
- QuickAddView has title field, date picker, opens Calendar.app
- Dropdown footer has quick-add plus button
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-meeting-links-notifications/06-06-SUMMARY.md`
</output>
