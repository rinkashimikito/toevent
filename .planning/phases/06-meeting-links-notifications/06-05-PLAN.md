---
phase: 06-meeting-links-notifications
plan: 05
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - ToEvent/ToEvent/Views/Settings/NotificationSettingsView.swift
  - ToEvent/ToEvent/State/AppState.swift
  - ToEvent/ToEvent/Services/NotificationService.swift
autonomous: true

must_haves:
  truths:
    - "User can enable/disable notifications in settings"
    - "User can choose reminder time (5min, 10min, 15min, etc.)"
    - "User can select notification sound"
    - "Selected notification sound is used when scheduling reminders"
    - "Notifications are scheduled automatically for upcoming events"
  artifacts:
    - path: "ToEvent/ToEvent/Views/Settings/NotificationSettingsView.swift"
      provides: "Notification preferences UI"
      min_lines: 80
    - path: "ToEvent/ToEvent/State/AppState.swift"
      provides: "Notification preference storage"
      contains: "notificationsEnabled"
  key_links:
    - from: "NotificationSettingsView.swift"
      to: "AppState.swift"
      via: "binds to notification preferences"
      pattern: "appState\\.notificationsEnabled"
    - from: "AppState.swift"
      to: "NotificationService.swift"
      via: "schedules reminders with sound option on event refresh"
      pattern: "scheduleReminder.*soundOption"
---

<objective>
Add notification settings UI and automatic reminder scheduling for events.

Purpose: Implements NOTF-04 (customizable sounds) and NOTF-05 (notification preferences). Connects notification infrastructure to user preferences.
Output: NotificationSettingsView, AppState notification preferences, automatic scheduling with sound preference
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-meeting-links-notifications/06-RESEARCH.md
@.planning/phases/06-meeting-links-notifications/06-02-SUMMARY.md
@ToEvent/ToEvent/State/AppState.swift
@ToEvent/ToEvent/Views/Settings/GeneralSettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notification preferences to AppState</name>
  <files>ToEvent/ToEvent/State/AppState.swift</files>
  <action>
Add notification preference properties and scheduling logic to AppState.

1. Add new Keys constants:
```swift
static let notificationsEnabled = "notificationsEnabled"
static let reminderMinutes = "reminderMinutes"
static let notificationSound = "notificationSound"
```

2. Add published properties after existing preference properties:
```swift
@Published var notificationsEnabled: Bool {
    didSet {
        UserDefaults.standard.set(notificationsEnabled, forKey: Keys.notificationsEnabled)
        if notificationsEnabled {
            scheduleNotificationsForEvents()
        } else {
            NotificationService.shared.cancelAllReminders()
        }
    }
}

@Published var reminderMinutes: Int {
    didSet {
        UserDefaults.standard.set(reminderMinutes, forKey: Keys.reminderMinutes)
        if notificationsEnabled {
            scheduleNotificationsForEvents()
        }
    }
}

enum NotificationSoundOption: String, CaseIterable, Identifiable {
    case `default` = "default"
    case subtle = "subtle"
    case urgent = "urgent"
    case none = "none"

    var id: String { rawValue }

    var displayName: String {
        switch self {
        case .default: return "Default"
        case .subtle: return "Subtle"
        case .urgent: return "Urgent"
        case .none: return "None"
        }
    }

    /// Convert to NotificationService's sound option type
    var toServiceOption: NotificationSoundOption {
        // Both enums have same raw values, so this works
        NotificationSoundOption(rawValue: self.rawValue) ?? .default
    }
}

@Published var notificationSound: NotificationSoundOption {
    didSet {
        UserDefaults.standard.set(notificationSound.rawValue, forKey: Keys.notificationSound)
        // Reschedule with new sound preference
        if notificationsEnabled {
            scheduleNotificationsForEvents()
        }
    }
}
```

3. Initialize in init():
```swift
self.notificationsEnabled = UserDefaults.standard.bool(forKey: Keys.notificationsEnabled)
self.reminderMinutes = UserDefaults.standard.integer(forKey: Keys.reminderMinutes)
if reminderMinutes == 0 { reminderMinutes = 5 }  // Default 5 minutes

if let soundRaw = UserDefaults.standard.string(forKey: Keys.notificationSound),
   let sound = NotificationSoundOption(rawValue: soundRaw) {
    self.notificationSound = sound
} else {
    self.notificationSound = .default
}
```

4. Add scheduling method that passes sound preference to NotificationService:
```swift
private func scheduleNotificationsForEvents() {
    guard notificationsEnabled else { return }

    // Cancel existing and reschedule
    NotificationService.shared.cancelAllReminders()

    // Schedule for upcoming events (not all-day, starting within 24 hours)
    let upcomingEvents = events.filter { event in
        !event.isAllDay &&
        event.startDate > Date() &&
        event.startDate < Date().addingTimeInterval(86400)
    }

    // Convert AppState sound option to NotificationService sound option
    let serviceSoundOption: NotificationSoundOption
    switch notificationSound {
    case .default: serviceSoundOption = .default
    case .subtle: serviceSoundOption = .subtle
    case .urgent: serviceSoundOption = .urgent
    case .none: serviceSoundOption = .none
    }

    Task {
        for event in upcomingEvents {
            try? await NotificationService.shared.scheduleReminder(
                for: event,
                minutesBefore: reminderMinutes,
                soundOption: serviceSoundOption
            )
        }
    }
}
```

5. Call scheduleNotificationsForEvents() at end of refreshEvents() after setting events:
```swift
if notificationsEnabled {
    scheduleNotificationsForEvents()
}
```

**Important:** The `soundOption` parameter MUST be passed to `scheduleReminder()`. This wires the user's sound preference to the actual notification sound.
  </action>
  <verify>Build succeeds; AppState has notification preferences; scheduleReminder called with soundOption parameter</verify>
  <done>AppState stores notification preferences and schedules reminders with sound preference on event refresh</done>
</task>

<task type="auto">
  <name>Task 2: Create NotificationSettingsView</name>
  <files>ToEvent/ToEvent/Views/Settings/NotificationSettingsView.swift</files>
  <action>
Create the notification settings view:

```swift
import SwiftUI
import Settings

struct NotificationSettingsView: View {
    @EnvironmentObject private var appState: AppState
    @ObservedObject private var notificationService = NotificationService.shared

    var body: some View {
        SettingsContainer {
            SettingsSection(title: "Notifications") {
                Toggle("Enable event reminders", isOn: $appState.notificationsEnabled)
                    .disabled(!notificationService.isAuthorized)

                if !notificationService.isAuthorized {
                    permissionWarning
                }

                if appState.notificationsEnabled {
                    reminderTimePicker
                    soundPicker
                }
            }

            SettingsSection(title: "Alert Style (Important)") {
                alertStyleInfo
            }
        }
    }

    private var permissionWarning: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                Image(systemName: "exclamationmark.triangle.fill")
                    .foregroundColor(.yellow)
                Text("Notification permission required")
                    .foregroundColor(.secondary)
            }

            Button("Request Permission") {
                Task {
                    _ = try? await notificationService.requestPermission()
                }
            }
        }
        .padding(.vertical, 4)
    }

    private var reminderTimePicker: some View {
        Picker("Remind me", selection: $appState.reminderMinutes) {
            Text("5 minutes before").tag(5)
            Text("10 minutes before").tag(10)
            Text("15 minutes before").tag(15)
            Text("30 minutes before").tag(30)
            Text("1 hour before").tag(60)
        }
    }

    private var soundPicker: some View {
        Picker("Sound", selection: $appState.notificationSound) {
            ForEach(AppState.NotificationSoundOption.allCases) { option in
                Text(option.displayName).tag(option)
            }
        }
    }

    private var alertStyleInfo: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack(spacing: 8) {
                Image(systemName: "info.circle.fill")
                    .foregroundColor(.blue)
                Text("Notifications stay visible until dismissed only when using \"Alerts\" style")
                    .font(.callout)
                    .fontWeight(.medium)
            }

            Divider()

            Text("To configure persistent notifications:")
                .foregroundColor(.secondary)
                .font(.callout)

            VStack(alignment: .leading, spacing: 4) {
                HStack(alignment: .top) {
                    Text("1.")
                        .frame(width: 20)
                    Text("Open System Settings > Notifications > ToEvent")
                }
                HStack(alignment: .top) {
                    Text("2.")
                        .frame(width: 20)
                    Text("Set \"ToEvent alert style\" to \"Alerts\" (not \"Banners\")")
                }
            }
            .font(.callout)
            .foregroundColor(.secondary)

            HStack {
                Button("Open Notification Settings") {
                    if let url = URL(string: "x-apple.systempreferences:com.apple.preference.notifications") {
                        NSWorkspace.shared.open(url)
                    }
                }

                Text("Then search for \"ToEvent\"")
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
            .padding(.top, 4)
        }
        .padding(.vertical, 4)
    }
}
```

Add file to Xcode project in Views/Settings group.
  </action>
  <verify>Build succeeds with NotificationSettingsView</verify>
  <done>NotificationSettingsView provides enable toggle, reminder time picker, sound picker, permission flow, and prominent alert style guidance</done>
</task>

<task type="auto">
  <name>Task 3: Add notification settings to settings window</name>
  <files>ToEvent/ToEvent/Views/Settings/GeneralSettingsView.swift</files>
  <action>
Add NotificationSettingsView to the settings window tabs.

Find where Settings.Pane is configured (likely in GeneralSettingsView or a settings coordinator). Add a new pane for notifications:

If using sindresorhus/Settings package, add to the panes array:

```swift
Settings.Pane(
    identifier: Settings.PaneIdentifier("notifications"),
    title: "Notifications",
    toolbarIcon: NSImage(systemSymbolName: "bell", accessibilityDescription: "Notifications")!
) {
    NotificationSettingsView()
        .environmentObject(appState)
}
```

If the settings are in a different structure, integrate NotificationSettingsView appropriately. The key is making it accessible from the settings window.

Look for where other settings panes (General, Display, Advanced, Calendars) are defined and add Notifications alongside them.
  </action>
  <verify>Build succeeds; Notifications tab appears in settings window</verify>
  <done>Notification settings accessible from settings window</done>
</task>

</tasks>

<verification>
1. Build: `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build`
2. NotificationSettingsView.swift exists in Views/Settings
3. AppState has notificationsEnabled, reminderMinutes, notificationSound
4. Settings window has Notifications pane
5. Enabling notifications schedules reminders for upcoming events
6. **scheduleReminder called with soundOption parameter matching user preference**
</verification>

<success_criteria>
- AppState stores notificationsEnabled, reminderMinutes, notificationSound
- NotificationSettingsView has permission check, enable toggle, time picker, sound picker
- **soundOption passed to NotificationService.scheduleReminder() based on notificationSound preference**
- Alert style section prominently explains system notification settings requirement
- Settings window includes Notifications pane
- Enabling notifications triggers scheduling for all upcoming events
- Changing reminder time or sound preference reschedules all notifications
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-meeting-links-notifications/06-05-SUMMARY.md`
</output>
