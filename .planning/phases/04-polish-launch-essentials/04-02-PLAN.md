---
phase: 04-polish-launch-essentials
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - ToEvent/ToEvent/State/AppState.swift
  - ToEvent/ToEvent/Utilities/DateFormatters.swift
  - ToEvent/ToEvent/Views/EventRowView.swift
  - ToEvent/ToEvent/ToEventApp.swift
  - ToEvent/ToEvent/Views/Settings/DisplaySettingsView.swift
  - ToEvent/ToEvent.xcodeproj/project.pbxproj
autonomous: true

must_haves:
  truths:
    - "User can choose time display format (countdown, absolute, or both)"
    - "User can toggle natural language mode for time display"
    - "User can enable privacy mode to hide event titles"
    - "Privacy mode hides titles in both menu bar and dropdown"
  artifacts:
    - path: "ToEvent/ToEvent/Views/Settings/DisplaySettingsView.swift"
      provides: "Display settings pane"
      contains: "TimeDisplayFormat"
    - path: "ToEvent/ToEvent/State/AppState.swift"
      provides: "Display preference properties"
      contains: "privacyMode"
  key_links:
    - from: "EventRowView.swift"
      to: "appState.timeDisplayFormat"
      via: "time display formatting"
      pattern: "timeDisplayFormat"
    - from: "ToEventApp.swift (MenuBarLabel)"
      to: "appState.privacyMode"
      via: "title masking"
      pattern: "privacyMode"
---

<objective>
Add display customization settings: time format selection, natural language mode, and privacy mode.

Purpose: Let users customize how event information is displayed based on personal preference and privacy needs.
Output: DisplaySettingsView with three settings, AppState properties, updated formatters and views to respect settings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish-launch-essentials/04-RESEARCH.md

@ToEvent/ToEvent/State/AppState.swift
@ToEvent/ToEvent/Utilities/DateFormatters.swift
@ToEvent/ToEvent/Views/EventRowView.swift
@ToEvent/ToEvent/ToEventApp.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add display settings properties to AppState</name>
  <files>ToEvent/ToEvent/State/AppState.swift</files>
  <action>
    Add enum for time display format (can be in AppState.swift or separate file):

    ```swift
    enum TimeDisplayFormat: String, CaseIterable, Identifiable {
        case countdown = "countdown"
        case absolute = "absolute"
        case both = "both"

        var id: String { rawValue }

        var label: String {
            switch self {
            case .countdown: return "Countdown (5m 30s)"
            case .absolute: return "Absolute (2:30 PM)"
            case .both: return "Both (5m 30s - 2:30 PM)"
            }
        }
    }
    ```

    Add three @Published properties to AppState:

    ```swift
    @Published var timeDisplayFormat: TimeDisplayFormat {
        didSet {
            UserDefaults.standard.set(timeDisplayFormat.rawValue, forKey: Keys.timeDisplayFormat)
            updateMenuBarTitle()
        }
    }

    @Published var useNaturalLanguage: Bool {
        didSet {
            UserDefaults.standard.set(useNaturalLanguage, forKey: Keys.useNaturalLanguage)
            updateMenuBarTitle()
        }
    }

    @Published var privacyMode: Bool {
        didSet {
            UserDefaults.standard.set(privacyMode, forKey: Keys.privacyMode)
            updateMenuBarTitle()
        }
    }
    ```

    Add Keys:
    ```swift
    static let timeDisplayFormat = "timeDisplayFormat"
    static let useNaturalLanguage = "useNaturalLanguage"
    static let privacyMode = "privacyMode"
    ```

    Initialize in init():
    ```swift
    if let formatRaw = UserDefaults.standard.string(forKey: Keys.timeDisplayFormat),
       let format = TimeDisplayFormat(rawValue: formatRaw) {
        self.timeDisplayFormat = format
    } else {
        self.timeDisplayFormat = .countdown
    }
    self.useNaturalLanguage = UserDefaults.standard.bool(forKey: Keys.useNaturalLanguage)
    self.privacyMode = UserDefaults.standard.bool(forKey: Keys.privacyMode)
    ```

    Update updateMenuBarTitle() to use privacyMode:
    ```swift
    private func updateMenuBarTitle() {
        guard let event = nextEvent else {
            menuBarTitle = "ToEvent"
            return
        }

        let displayTitle: String
        if privacyMode {
            displayTitle = "Event"
        } else {
            displayTitle = event.title.count > 18
                ? String(event.title.prefix(18)) + "..."
                : event.title
        }

        if event.isAllDay {
            menuBarTitle = "\(displayTitle) - Today"
        } else {
            let timeString = formatTimeForMenuBar(until: event.startDate, from: currentTime)
            menuBarTitle = "\(displayTitle) - \(timeString)"
        }
    }

    private func formatTimeForMenuBar(until date: Date, from now: Date) -> String {
        switch timeDisplayFormat {
        case .countdown:
            return useNaturalLanguage
                ? DateFormatters.formatNaturalLanguage(until: date, from: now)
                : DateFormatters.formatHybridCountdown(until: date, from: now)
        case .absolute:
            return DateFormatters.formatAbsoluteTime(date)
        case .both:
            let countdown = useNaturalLanguage
                ? DateFormatters.formatNaturalLanguage(until: date, from: now)
                : DateFormatters.formatHybridCountdown(until: date, from: now)
            let absolute = DateFormatters.formatAbsoluteTime(date)
            return "\(countdown) - \(absolute)"
        }
    }
    ```
  </action>
  <verify>
    - Build succeeds
    - No missing Keys or undefined formatters yet (will add in Task 2)
  </verify>
  <done>
    AppState has timeDisplayFormat, useNaturalLanguage, and privacyMode properties.
    All persist to UserDefaults and trigger menu bar title updates.
    Privacy mode replaces event title with "Event" in menu bar.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add natural language and absolute time formatters</name>
  <files>ToEvent/ToEvent/Utilities/DateFormatters.swift</files>
  <action>
    Add two new formatters to DateFormatters enum:

    ```swift
    private static let absoluteTimeFormatter: DateFormatter = {
        let formatter = DateFormatter()
        formatter.timeStyle = .short
        return formatter
    }()

    static func formatAbsoluteTime(_ date: Date) -> String {
        return absoluteTimeFormatter.string(from: date)
    }

    static func formatNaturalLanguage(until date: Date, from now: Date = Date()) -> String {
        let interval = date.timeIntervalSince(now)

        if interval <= 0 {
            return "now"
        }

        if interval < 60 {
            return "now"  // Less than a minute = "now"
        }

        if interval < 300 {  // < 5 min
            return "very soon"
        }

        if interval < 900 {  // < 15 min
            return "soon"
        }

        if interval < 1800 {  // < 30 min
            return "shortly"
        }

        if interval < 3600 {  // < 1 hour
            return "in under an hour"
        }

        if interval < 7200 {  // < 2 hours
            return "in about an hour"
        }

        // Fall back to hours for longer durations
        let hours = Int(interval / 3600)
        return "in \(hours) hours"
    }
    ```

    Natural language thresholds:
    - < 1 min: "now"
    - < 5 min: "very soon"
    - < 15 min: "soon"
    - < 30 min: "shortly"
    - < 1 hour: "in under an hour"
    - < 2 hours: "in about an hour"
    - 2+ hours: "in N hours"
  </action>
  <verify>
    - Build succeeds
    - DateFormatters.formatAbsoluteTime(Date()) returns time string like "2:30 PM"
    - DateFormatters.formatNaturalLanguage(until: Date().addingTimeInterval(600), from: Date()) returns "soon"
  </verify>
  <done>
    DateFormatters has formatAbsoluteTime for absolute time display.
    DateFormatters has formatNaturalLanguage for human-friendly time descriptions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create DisplaySettingsView and update EventRowView</name>
  <files>
    ToEvent/ToEvent/Views/Settings/DisplaySettingsView.swift
    ToEvent/ToEvent/Views/EventRowView.swift
    ToEvent/ToEvent/ToEventApp.swift
    ToEvent/ToEvent.xcodeproj/project.pbxproj
  </files>
  <action>
    Create DisplaySettingsView.swift:

    ```swift
    import SwiftUI

    struct DisplaySettingsView: View {
        @EnvironmentObject private var appState: AppState

        var body: some View {
            SettingsContainer(contentWidth: 450) {
                SettingsSection(title: "Time Display") {
                    Picker("Format:", selection: $appState.timeDisplayFormat) {
                        ForEach(TimeDisplayFormat.allCases) { format in
                            Text(format.label).tag(format)
                        }
                    }
                    .pickerStyle(.menu)

                    Toggle("Use natural language (\"soon\" instead of \"in 5m\")", isOn: $appState.useNaturalLanguage)
                        .disabled(appState.timeDisplayFormat == .absolute)
                }

                SettingsSection(title: "Privacy") {
                    Toggle("Hide event titles", isOn: $appState.privacyMode)
                    Text("Shows \"Event\" instead of actual event title")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }
            }
        }
    }

    extension DisplaySettingsView {
        static let pane: SettingsPane = SettingsPane(
            identifier: SettingsPaneIdentifier("display"),
            title: "Display",
            toolbarIcon: NSImage(systemSymbolName: "textformat", accessibilityDescription: "Display")!
        ) {
            DisplaySettingsView()
        }
    }
    ```

    Update EventRowView to use appState settings:

    Add @EnvironmentObject to EventRowView:
    ```swift
    @EnvironmentObject private var appState: AppState
    ```

    Update truncatedTitle:
    ```swift
    private var truncatedTitle: String {
        if appState.privacyMode {
            return "Event"
        }
        if event.title.count > 30 {
            return String(event.title.prefix(30)) + "..."
        }
        return event.title
    }
    ```

    Update timeDisplay to respect format settings:
    ```swift
    private var timeDisplay: String {
        if event.isAllDay {
            return "All day"
        }

        switch appState.timeDisplayFormat {
        case .countdown:
            return formatCountdown()
        case .absolute:
            return DateFormatters.formatAbsoluteTime(event.startDate)
        case .both:
            let countdown = formatCountdown()
            let absolute = DateFormatters.formatAbsoluteTime(event.startDate)
            return "\(countdown) - \(absolute)"
        }
    }

    private func formatCountdown() -> String {
        if appState.useNaturalLanguage {
            return DateFormatters.formatNaturalLanguage(until: event.startDate)
        }
        let remaining = event.startDate.timeIntervalSince(Date())
        if remaining <= 3600 {
            return DateFormatters.formatHybridCountdown(until: event.startDate)
        }
        return Self.timeFormatter.string(from: event.startDate)
    }
    ```

    Update ToEventApp.swift to register DisplaySettingsView:
    ```swift
    SwiftUI.Settings {
        GeneralSettingsView()
            .environmentObject(appState)
        DisplaySettingsView()
            .environmentObject(appState)
        CalendarSettingsView()
            .environmentObject(appState)
    }
    ```

    Add DisplaySettingsView.swift to Xcode project sources.
  </action>
  <verify>
    - Build succeeds
    - Settings shows Display pane between General and Calendar
    - Changing time format updates dropdown event times
    - Toggling natural language changes "5m" to "soon"
    - Enabling privacy mode shows "Event" instead of titles
    - Privacy mode affects both menu bar and dropdown
  </verify>
  <done>
    DisplaySettingsView created with time format, natural language, and privacy settings.
    EventRowView respects all display settings.
    Menu bar respects privacy mode.
    Settings pane registered in app.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. Build: `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build`
2. Run app
3. Open Settings > Display
4. Test time format: countdown shows "5m 30s", absolute shows "2:30 PM", both shows "5m 30s - 2:30 PM"
5. Toggle natural language: countdown changes to "soon", "shortly", etc.
6. Enable privacy mode: menu bar shows "Event - 5m", dropdown shows "Event" for all entries
7. Disable privacy mode: titles return
</verification>

<success_criteria>
- CUST-04 complete: Time display format configurable (countdown/absolute/both)
- MENU-06 complete: Natural language option available
- MENU-07 complete: Privacy mode hides event titles everywhere
- All settings persist across app restarts
- UI follows existing SettingsSection pattern
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-launch-essentials/04-02-SUMMARY.md`
</output>
