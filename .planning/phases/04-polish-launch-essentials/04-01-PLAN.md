---
phase: 04-polish-launch-essentials
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ToEvent/ToEvent.xcodeproj/project.pbxproj
  - ToEvent/ToEvent/ToEventApp.swift
  - ToEvent/ToEvent/Extensions/KeyboardShortcuts+Names.swift
  - ToEvent/ToEvent/Views/Settings/GeneralSettingsView.swift
autonomous: true

must_haves:
  truths:
    - "User can press a global keyboard shortcut to toggle the dropdown"
    - "App auto-launches at login when enabled in settings"
    - "User can customize the keyboard shortcut in Settings"
    - "User can toggle auto-launch in Settings"
  artifacts:
    - path: "ToEvent/ToEvent/Extensions/KeyboardShortcuts+Names.swift"
      provides: "Shortcut name definition"
      contains: "KeyboardShortcuts.Name"
    - path: "ToEvent/ToEvent/Views/Settings/GeneralSettingsView.swift"
      provides: "Startup and keyboard settings UI"
      contains: "LaunchAtLogin.Toggle"
  key_links:
    - from: "ToEventApp.swift"
      to: "KeyboardShortcuts.onKeyUp"
      via: "shortcut listener in init"
      pattern: "KeyboardShortcuts\\.onKeyUp"
    - from: "GeneralSettingsView.swift"
      to: "KeyboardShortcuts.Recorder"
      via: "settings UI"
      pattern: "KeyboardShortcuts\\.Recorder"
---

<objective>
Add global keyboard shortcut to toggle dropdown and auto-launch at login capability.

Purpose: Core system integration features that improve daily usability - quick access via keyboard and automatic startup.
Output: KeyboardShortcuts and LaunchAtLogin packages integrated, GeneralSettingsView extended with startup/keyboard sections.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish-launch-essentials/04-RESEARCH.md

@ToEvent/ToEvent/ToEventApp.swift
@ToEvent/ToEvent/Views/Settings/GeneralSettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SPM dependencies and create shortcut name extension</name>
  <files>
    ToEvent/ToEvent.xcodeproj/project.pbxproj
    ToEvent/ToEvent/Extensions/KeyboardShortcuts+Names.swift
  </files>
  <action>
    Add two SPM packages to Xcode project:
    - https://github.com/sindresorhus/KeyboardShortcuts (latest)
    - https://github.com/sindresorhus/LaunchAtLogin-Modern (latest)

    Use xcodebuild or direct project.pbxproj manipulation:
    ```bash
    cd ToEvent && swift package resolve
    ```
    Or add via Xcode SPM interface if direct manipulation is complex.

    Create Extensions/KeyboardShortcuts+Names.swift:
    ```swift
    import KeyboardShortcuts

    extension KeyboardShortcuts.Name {
        static let toggleDropdown = Self("toggleDropdown", default: .init(.e, modifiers: [.command, .option]))
    }
    ```

    Default: Cmd+Option+E (easy to type, unlikely to conflict).

    Add the new file to Xcode project sources.
  </action>
  <verify>
    - `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent -showBuildSettings 2>&1 | grep -i keyboard` shows KeyboardShortcuts
    - File exists: ToEvent/ToEvent/Extensions/KeyboardShortcuts+Names.swift
    - Project builds: `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build 2>&1 | tail -5`
  </verify>
  <done>
    KeyboardShortcuts and LaunchAtLogin-Modern packages added to Xcode project.
    KeyboardShortcuts+Names.swift created with .toggleDropdown shortcut name.
    Project compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire keyboard shortcut to toggle dropdown in ToEventApp</name>
  <files>ToEvent/ToEvent/ToEventApp.swift</files>
  <action>
    Import KeyboardShortcuts at top of file.

    In ToEventApp, add shortcut listener. The challenge: init() cannot capture @State vars.

    Solution pattern from research:
    ```swift
    import KeyboardShortcuts

    @main
    struct ToEventApp: App {
        @StateObject private var appState = AppState()
        @State private var isMenuPresented = false
        @State private var statusItem: NSStatusItem?

        var body: some Scene {
            MenuBarExtra { ... }
                .menuBarExtraStyle(.window)
                .menuBarExtraAccess(isPresented: $isMenuPresented) { item in
                    statusItem = item
                    applyUrgencyAppearance(to: item)
                }
                .onAppear {
                    KeyboardShortcuts.onKeyUp(for: .toggleDropdown) { [self] in
                        isMenuPresented.toggle()
                    }
                }
            // ...
        }
    }
    ```

    Note: Cannot use init() for KeyboardShortcuts because it needs to capture @State.
    Use .onAppear on MenuBarExtra content or a separate approach.

    Alternative approach if onAppear doesn't work with MenuBarExtra:
    Create an AppDelegate or use a helper class that holds the binding reference.

    Simplest approach: Use task modifier on the body:
    ```swift
    var body: some Scene {
        MenuBarExtra { ... }
            .task {
                for await _ in KeyboardShortcuts.events(for: .toggleDropdown) {
                    await MainActor.run {
                        isMenuPresented.toggle()
                    }
                }
            }
    }
    ```

    Test which approach works with MenuBarExtra + MenuBarExtraAccess binding.
  </action>
  <verify>
    - Build succeeds
    - Run app, press Cmd+Option+E, dropdown toggles
    - Press again, dropdown closes
  </verify>
  <done>
    Global keyboard shortcut (Cmd+Option+E by default) toggles the menu bar dropdown.
    Works whether dropdown is open or closed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add startup and keyboard settings to GeneralSettingsView</name>
  <files>ToEvent/ToEvent/Views/Settings/GeneralSettingsView.swift</files>
  <action>
    Import LaunchAtLogin and KeyboardShortcuts at top.

    Add two new sections to GeneralSettingsView body, BEFORE the existing "Events" section:

    ```swift
    SettingsSection(title: "Startup") {
        LaunchAtLogin.Toggle("Launch ToEvent at login")
    }

    SettingsSection(title: "Keyboard Shortcut") {
        KeyboardShortcuts.Recorder("Toggle dropdown:", name: .toggleDropdown)
    }
    ```

    Order in settings: Startup -> Keyboard -> Events (existing)

    The LaunchAtLogin.Toggle automatically reads from SMAppService and persists state.
    The KeyboardShortcuts.Recorder allows user to change the default shortcut.
  </action>
  <verify>
    - Build succeeds
    - Open Settings > General, see "Startup" section with toggle
    - See "Keyboard Shortcut" section with recorder
    - Toggle launch at login, check System Settings > General > Login Items shows ToEvent
    - Click recorder, press new shortcut combo, verify it works
  </verify>
  <done>
    GeneralSettingsView has Startup section with auto-launch toggle.
    GeneralSettingsView has Keyboard Shortcut section with customizable shortcut recorder.
    Both persist correctly and function as expected.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. Build: `xcodebuild -project ToEvent/ToEvent.xcodeproj -scheme ToEvent build`
2. Run app manually
3. Test keyboard shortcut toggles dropdown (default Cmd+Option+E)
4. Open Settings > General
5. Verify "Launch at login" toggle exists and functions
6. Verify "Keyboard Shortcut" recorder exists and allows customization
7. Change shortcut, verify new shortcut works
</verification>

<success_criteria>
- SYST-01 complete: Global keyboard shortcut toggles dropdown
- SYST-02 complete: Auto-launch at login configurable in Settings
- Both features use production-quality sindresorhus packages
- Settings UI matches existing SettingsSection pattern
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-launch-essentials/04-01-SUMMARY.md`
</output>
